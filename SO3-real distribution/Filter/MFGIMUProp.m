function [ Miutdt, Sigmatdt, Ptdt, Utdt, Stdt, Vtdt ] = MFGIMUProp...
    ( omega, a, Miu, Sigma, P, U, S, V, H, defQS, dt, options )
% disassemble variables
g = [0;0;9.8];

Hgu = H.Hgu;
Hgv = H.Hgv;
Hau = H.Hau;
Hav = H.Hav;

Ggu = Hgu*Hgu';
Ggv = Hgv*Hgv';
Gau = Hau*Hau';
Gav = Hav*Hav';

Miubg = Miu(1:3);
Miup = Miu(4:6);
Miuv = Miu(7:9);
Miuba = Miu(10:12);

Pbg = P(1:3,:);
Pp = P(4:6,:);
Pv = P(7:9,:);
Pba = P(10:12,:);

s = diag(S);
[EQ,EQQ,EQQQ] = pdf_MF_moment123(s);

ERt = U*EQ*V';

%% E[R(t+dt)]
ERtdt = getERtdt(omega,Miubg,Pbg,U,V,Hgu,EQ,dt,true,defQS);

[Utdt,D,Vtdt] = psvd(ERtdt);
Stdt = diag(pdf_MF_M2S_TR(diag(D),s,options));

%% E[x(t+dt)]
Ebgtdt = Miubg;
Eptdt = Miup + dt*Miuv;
Ebatdt = Miuba;

VPba = V'*Pba;
if defQS
    ERPbavRt(1,1) = (-VPba(2,3)*s(2))*EQQ(2,2) +(VPba(2,3)*s(1))*EQQ(2,4) +(VPba(3,2)*s(3))*EQQ(3,3) +(-VPba(3,2)*s(1))*EQQ(3,7);
    ERPbavRt(2,1) = (VPba(1,3)*s(1))*EQQ(2,2) +(-VPba(1,3)*s(2))*EQQ(2,4) +(-VPba(3,1)*s(3))*EQQ(6,6) +(VPba(3,1)*s(2))*EQQ(6,8);
    ERPbavRt(3,1) = (-VPba(1,2)*s(1))*EQQ(3,3) +(VPba(1,2)*s(3))*EQQ(3,7) +(VPba(2,1)*s(2))*EQQ(6,6) +(-VPba(2,1)*s(3))*EQQ(6,8);
else
    ERPbavRt(1,1) = (-VPba(2,3)*s(1))*EQQ(2,2) +(VPba(2,3)*s(2))*EQQ(2,4) +(VPba(3,2)*s(1))*EQQ(3,3) +(-VPba(3,2)*s(3))*EQQ(3,7);
    ERPbavRt(2,1) = (VPba(1,3)*s(2))*EQQ(2,2) +(-VPba(1,3)*s(1))*EQQ(2,4) +(-VPba(3,1)*s(2))*EQQ(6,6) +(VPba(3,1)*s(3))*EQQ(6,8);
    ERPbavRt(3,1) = (-VPba(1,2)*s(3))*EQQ(3,3) +(VPba(1,2)*s(1))*EQQ(3,7) +(VPba(2,1)*s(3))*EQQ(6,6) +(-VPba(2,1)*s(2))*EQQ(6,8);
end
ERPbavRt = U*ERPbavRt;

Evtdt = Miuv + ERt*(a+Miuba)*dt + ERPbavRt*dt - dt*g;

Extdt = [Ebgtdt;Eptdt;Evtdt;Ebatdt];

%% E[x(t+dt)v'R(t+dt)]
UT = Utdt'*U;
VT = Vtdt'*expRot((omega+Miubg)*dt)'*V;
ST = UT'*Stdt*VT;

VTT = Vtdt'*expRot((omega+Miubg)*dt)'*Ggu'*V;
STT = UT'*Stdt*VTT;

if defQS
    EvRdRpt = UT*vee(EQ*ST'-ST*EQ',[],false);
else
    EvRdRpt = VT*vee(ST'*EQ-EQ'*ST,[],false);
end

if defQS
    EvRvRdRpt = [ST(2,2)*EQ(2,2)+ST(3,3)*EQ(3,3), -ST(1,2)*EQ(2,2), -ST(1,3)*EQ(3,3)
        -ST(2,1)*EQ(1,1), ST(1,1)*EQ(1,1)+ST(3,3)*EQ(3,3), -ST(2,3)*EQ(3,3)
        -ST(3,1)*EQ(1,1), -ST(3,2)*EQ(2,2), ST(1,1)*EQ(1,1)+ST(2,2)*EQ(2,2)];
    EvRvRdRpt = EvRvRdRpt*UT';
else
    EvRvRdRpt = [ST(2,2)*EQ(2,2)+ST(3,3)*EQ(3,3), -ST(2,1)*EQ(2,2), -ST(3,1)*EQ(3,3)
        -ST(1,2)*EQ(1,1), ST(1,1)*EQ(1,1)+ST(3,3)*EQ(3,3), -ST(3,2)*EQ(3,3)
        -ST(1,3)*EQ(1,1), -ST(2,3)*EQ(2,2), ST(1,1)*EQ(1,1)+ST(2,2)*EQ(2,2)];
    EvRvRdRpt = EvRvRdRpt*VT';
end

% ExvRdRptdt
EbgvRdRpt = Miubg*EvRdRpt' + Pbg*EvRvRdRpt;
EpvRdRpt = Miup*EvRdRpt' + Pp*EvRvRdRpt;
EvvRdRpt = Miuv*EvRdRpt' + Pv*EvRvRdRpt;
EbavRdRpt = Miuba*EvRdRpt' + Pba*EvRvRdRpt;

Va = V'*(a+Miuba);
if defQS
    ERavRdRpt(1,1) = (-ST(3,2)*Va(1))*EQQ(1,5) +(ST(2,3)*Va(1))*EQQ(1,9)...
        + (-ST(3,1)*Va(2))*EQQ(2,4) +(ST(2,1)*Va(3))*EQQ(3,7);
    ERavRdRpt(1,2) = (ST(3,1)*Va(1))*EQQ(1,1) +(-ST(1,3)*Va(1))*EQQ(1,9)...
        + (ST(3,2)*Va(2))*EQQ(2,2) +(ST(3,3)*Va(3))*EQQ(3,3) +(-ST(1,1)*Va(3))*EQQ(3,7);
    ERavRdRpt(1,3) = (-ST(2,1)*Va(1))*EQQ(1,1) +(ST(1,2)*Va(1))*EQQ(1,5)...
        + (-ST(2,2)*Va(2))*EQQ(2,2) +(ST(1,1)*Va(2))*EQQ(2,4) +(-ST(2,3)*Va(3))*EQQ(3,3);
    ERavRdRpt(2,1) = (-ST(3,2)*Va(2))*EQQ(5,5) +(ST(2,3)*Va(2))*EQQ(5,9)...
        + (-ST(3,1)*Va(1))*EQQ(2,2) +(-ST(3,3)*Va(3))*EQQ(6,6) +(ST(2,2)*Va(3))*EQQ(6,8);
    ERavRdRpt(2,2) = (ST(3,1)*Va(2))*EQQ(1,5) +(-ST(1,3)*Va(2))*EQQ(5,9)...
        + (ST(3,2)*Va(1))*EQQ(2,4) +(-ST(1,2)*Va(3))*EQQ(6,8);
    ERavRdRpt(2,3) = (-ST(2,1)*Va(2))*EQQ(1,5) +(ST(1,2)*Va(2))*EQQ(5,5)...
        + (ST(1,1)*Va(1))*EQQ(2,2) +(-ST(2,2)*Va(1))*EQQ(2,4) +(ST(1,3)*Va(3))*EQQ(6,6);
    ERavRdRpt(3,1) = (-ST(3,2)*Va(3))*EQQ(5,9) +(ST(2,3)*Va(3))*EQQ(9,9)...
        + (ST(2,1)*Va(1))*EQQ(3,3) +(ST(2,2)*Va(2))*EQQ(6,6) +(-ST(3,3)*Va(2))*EQQ(6,8);
    ERavRdRpt(3,2) = (ST(3,1)*Va(3))*EQQ(1,9) +(-ST(1,3)*Va(3))*EQQ(9,9)...
        + (-ST(1,1)*Va(1))*EQQ(3,3) +(ST(3,3)*Va(1))*EQQ(3,7) +(-ST(1,2)*Va(2))*EQQ(6,6);
    ERavRdRpt(3,3) = (-ST(2,1)*Va(3))*EQQ(1,9) +(ST(1,2)*Va(3))*EQQ(5,9)...
        + (-ST(2,3)*Va(1))*EQQ(3,7) +(ST(1,3)*Va(2))*EQQ(6,8);
    ERavRdRpt = U*ERavRdRpt*UT';
else
    ERavRdRpt(1,1) = (ST(2,3)*Va(1))*EQQ(1,5) +(-ST(3,2)*Va(1))*EQQ(1,9)...
        + (ST(1,3)*Va(2))*EQQ(2,2) +(-ST(1,2)*Va(3))*EQQ(3,3);
    ERavRdRpt(1,2) = (-ST(1,3)*Va(1))*EQQ(1,1) +(ST(3,1)*Va(1))*EQQ(1,9)...
        + (-ST(2,3)*Va(2))*EQQ(2,4) +(ST(1,1)*Va(3))*EQQ(3,3) +(-ST(3,3)*Va(3))*EQQ(3,7);
    ERavRdRpt(1,3) = (ST(1,2)*Va(1))*EQQ(1,1) +(-ST(2,1)*Va(1))*EQQ(1,5)...
        + (-ST(1,1)*Va(2))*EQQ(2,2) +(ST(2,2)*Va(2))*EQQ(2,4) +(ST(3,2)*Va(3))*EQQ(3,7);
    ERavRdRpt(2,1) = (ST(2,3)*Va(2))*EQQ(5,5) +(-ST(3,2)*Va(2))*EQQ(5,9)...
        + (ST(1,3)*Va(1))*EQQ(2,4) +(-ST(2,2)*Va(3))*EQQ(6,6) +(ST(3,3)*Va(3))*EQQ(6,8);
    ERavRdRpt(2,2) = (-ST(1,3)*Va(2))*EQQ(1,5) +(ST(3,1)*Va(2))*EQQ(5,9)...
        + (-ST(2,3)*Va(1))*EQQ(2,2) +(ST(2,1)*Va(3))*EQQ(6,6);
    ERavRdRpt(2,3) = (ST(1,2)*Va(2))*EQQ(1,5) +(-ST(2,1)*Va(2))*EQQ(5,5)...
        + (ST(2,2)*Va(1))*EQQ(2,2) +(-ST(1,1)*Va(1))*EQQ(2,4) +(-ST(3,1)*Va(3))*EQQ(6,8);
    ERavRdRpt(3,1) = (ST(2,3)*Va(3))*EQQ(5,9) +(-ST(3,2)*Va(3))*EQQ(9,9)...
        + (-ST(1,2)*Va(1))*EQQ(3,7) +(ST(3,3)*Va(2))*EQQ(6,6) +(-ST(2,2)*Va(2))*EQQ(6,8);
    ERavRdRpt(3,2) = (-ST(1,3)*Va(3))*EQQ(1,9) +(ST(3,1)*Va(3))*EQQ(9,9)...
        + (-ST(3,3)*Va(1))*EQQ(3,3) +(ST(1,1)*Va(1))*EQQ(3,7) +(ST(2,1)*Va(2))*EQQ(6,8);
    ERavRdRpt(3,3) = (ST(1,2)*Va(3))*EQQ(1,9) +(-ST(2,1)*Va(3))*EQQ(5,9)...
        + (ST(3,2)*Va(1))*EQQ(3,3) +(-ST(3,1)*Va(2))*EQQ(6,6);
    ERavRdRpt = U*ERavRdRpt*VT';
end

VPba = V'*Pba;
if defQS
    ERPbavRvRdRpt(1,1) = (-ST(3,1)*VPba(1,3)*s(1))*EQQQ(1,2,2) +(ST(3,1)*VPba(1,3)*s(2))*EQQQ(1,2,4)...
        + (-ST(2,1)*VPba(1,2)*s(1))*EQQQ(1,3,3) +(ST(2,1)*VPba(1,2)*s(3))*EQQQ(1,3,7)...
        + (ST(2,2)*VPba(1,1)*s(2)+ST(3,3)*VPba(1,1)*s(3))*EQQQ(1,6,6)...
        + (-ST(2,2)*VPba(1,1)*s(3)-ST(3,3)*VPba(1,1)*s(2))*EQQQ(1,6,8)...
        + (ST(3,2)*VPba(2,3)*s(2))*EQQQ(5,2,2) +(-ST(3,2)*VPba(2,3)*s(1))*EQQQ(5,2,4)...
        + (-ST(3,2)*VPba(3,2)*s(3))*EQQQ(5,3,3) +(ST(3,2)*VPba(3,2)*s(1))*EQQQ(5,3,7)...
        + (-ST(2,3)*VPba(2,3)*s(2))*EQQQ(9,2,2) +(ST(2,3)*VPba(2,3)*s(1))*EQQQ(9,2,4)...
        + (ST(2,3)*VPba(3,2)*s(3))*EQQQ(9,3,3) +(-ST(2,3)*VPba(3,2)*s(1))*EQQQ(9,3,7)...
        + (ST(2,2)*VPba(3,3)*s(1)-ST(2,1)*VPba(2,1)*s(3)+ST(3,3)*VPba(2,2)*s(1)-ST(3,1)*VPba(3,1)*s(2))*EQQQ(2,6,7)...
        + (ST(2,1)*VPba(2,1)*s(2)-ST(2,2)*VPba(2,2)*s(1)+ST(3,1)*VPba(3,1)*s(3)-ST(3,3)*VPba(3,3)*s(1))*EQQQ(4,3,6)...
        + (ST(3,3)*VPba(3,3)*s(2)-ST(3,3)*VPba(2,2)*s(3))*EQQQ(2,6,3)...
        + (ST(2,2)*VPba(2,2)*s(3)-ST(2,2)*VPba(3,3)*s(2))*EQQQ(3,8,2);
    ERPbavRvRdRpt(1,2) = (-ST(3,2)*VPba(1,3)*s(2)-ST(3,1)*VPba(2,3)*s(2))*EQQQ(1,2,2)...
        + (ST(3,2)*VPba(1,3)*s(1)+ST(3,1)*VPba(2,3)*s(1))*EQQQ(1,2,4)...
        + (ST(1,1)*VPba(1,2)*s(1)+ST(3,3)*VPba(1,2)*s(3)+ST(3,1)*VPba(3,2)*s(3))*EQQQ(1,3,3)...
        + (-ST(1,1)*VPba(1,2)*s(3)-ST(3,3)*VPba(1,2)*s(1)-ST(3,1)*VPba(3,2)*s(1))*EQQQ(1,3,7)...
        + (-ST(1,2)*VPba(1,1)*s(2))*EQQQ(1,6,6) +(ST(1,2)*VPba(1,1)*s(3))*EQQQ(1,6,8)...
        + (ST(1,3)*VPba(2,3)*s(2))*EQQQ(9,2,2) +(-ST(1,3)*VPba(2,3)*s(1))*EQQQ(9,2,4)...
        + (-ST(1,3)*VPba(3,2)*s(3))*EQQQ(9,3,3) +(ST(1,3)*VPba(3,2)*s(1))*EQQQ(9,3,7)...
        + (ST(1,1)*VPba(2,1)*s(3)-ST(1,2)*VPba(3,3)*s(1))*EQQQ(2,6,7)...
        + (ST(1,2)*VPba(2,2)*s(1)-ST(1,1)*VPba(2,1)*s(2))*EQQQ(4,3,6)...
        + (-ST(3,3)*VPba(2,1)*s(3)-ST(3,2)*VPba(3,1)*s(3))*EQQQ(2,6,3)...
        + (ST(1,2)*VPba(3,3)*s(2)-ST(1,2)*VPba(2,2)*s(3)+ST(3,3)*VPba(2,1)*s(2)+ST(3,2)*VPba(3,1)*s(2))*EQQQ(3,8,2);
    ERPbavRvRdRpt(1,3) = (ST(1,1)*VPba(1,3)*s(1)+ST(2,2)*VPba(1,3)*s(2)+ST(2,1)*VPba(2,3)*s(2))*EQQQ(1,2,2)...
        + (-ST(1,1)*VPba(1,3)*s(2)-ST(2,2)*VPba(1,3)*s(1)-ST(2,1)*VPba(2,3)*s(1))*EQQQ(1,2,4)...
        + (-ST(2,3)*VPba(1,2)*s(3)-ST(2,1)*VPba(3,2)*s(3))*EQQQ(1,3,3)...
        + (ST(2,3)*VPba(1,2)*s(1)+ST(2,1)*VPba(3,2)*s(1))*EQQQ(1,3,7)...
        + (-ST(1,3)*VPba(1,1)*s(3))*EQQQ(1,6,6) +(ST(1,3)*VPba(1,1)*s(2))*EQQQ(1,6,8)...
        + (-ST(1,2)*VPba(2,3)*s(2))*EQQQ(5,2,2) +(ST(1,2)*VPba(2,3)*s(1))*EQQQ(5,2,4)...
        + (ST(1,2)*VPba(3,2)*s(3))*EQQQ(5,3,3) +(-ST(1,2)*VPba(3,2)*s(1))*EQQQ(5,3,7)...
        + (ST(1,1)*VPba(3,1)*s(2)-ST(1,3)*VPba(2,2)*s(1))*EQQQ(2,6,7)...
        + (ST(1,3)*VPba(3,3)*s(1)-ST(1,1)*VPba(3,1)*s(3))*EQQQ(4,3,6)...
        + (ST(1,3)*VPba(2,2)*s(3)+ST(2,3)*VPba(2,1)*s(3)-ST(1,3)*VPba(3,3)*s(2)+ST(2,2)*VPba(3,1)*s(3))*EQQQ(2,6,3)...
        + (-ST(2,3)*VPba(2,1)*s(2)-ST(2,2)*VPba(3,1)*s(2))*EQQQ(3,8,2);
    ERPbavRvRdRpt(2,1) = (-ST(3,2)*VPba(1,3)*s(1)-ST(3,1)*VPba(2,3)*s(1))*EQQQ(5,2,2)...
        + (ST(3,2)*VPba(1,3)*s(2)+ST(3,1)*VPba(2,3)*s(2))*EQQQ(5,2,4)...
        + (-ST(2,1)*VPba(2,2)*s(1))*EQQQ(5,3,3) +(ST(2,1)*VPba(2,2)*s(3))*EQQQ(5,3,7)...
        + (ST(2,2)*VPba(2,1)*s(2)+ST(3,3)*VPba(2,1)*s(3)+ST(3,2)*VPba(3,1)*s(3))*EQQQ(5,6,6)...
        + (-ST(2,2)*VPba(2,1)*s(3)-ST(3,3)*VPba(2,1)*s(2)-ST(3,2)*VPba(3,1)*s(2))*EQQQ(5,6,8)...
        + (ST(2,3)*VPba(1,3)*s(1))*EQQQ(9,2,2) +(-ST(2,3)*VPba(1,3)*s(2))*EQQQ(9,2,4)...
        + (-ST(2,3)*VPba(3,1)*s(3))*EQQQ(9,6,6) +(ST(2,3)*VPba(3,1)*s(2))*EQQQ(9,6,8)...
        + (ST(2,2)*VPba(1,2)*s(3)-ST(2,1)*VPba(3,3)*s(2))*EQQQ(2,6,7)...
        + (-ST(3,3)*VPba(1,2)*s(3)-ST(3,1)*VPba(3,2)*s(3))*EQQQ(4,3,6)...
        + (ST(2,1)*VPba(1,1)*s(2)-ST(2,2)*VPba(1,2)*s(1))*EQQQ(2,6,3)...
        + (ST(3,3)*VPba(1,2)*s(1)-ST(2,1)*VPba(1,1)*s(3)+ST(2,1)*VPba(3,3)*s(1)+ST(3,1)*VPba(3,2)*s(1))*EQQQ(3,8,2);
    ERPbavRvRdRpt(2,2) = (ST(3,1)*VPba(1,3)*s(1))*EQQQ(1,2,2) +(-ST(3,1)*VPba(1,3)*s(2))*EQQQ(1,2,4)...
        + (-ST(3,1)*VPba(3,1)*s(3))*EQQQ(1,6,6) +(ST(3,1)*VPba(3,1)*s(2))*EQQQ(1,6,8)...
        + (-ST(3,2)*VPba(2,3)*s(2))*EQQQ(5,2,2) +(ST(3,2)*VPba(2,3)*s(1))*EQQQ(5,2,4)...
        + (ST(1,1)*VPba(2,2)*s(1)+ST(3,3)*VPba(2,2)*s(3))*EQQQ(5,3,3)...
        + (-ST(1,1)*VPba(2,2)*s(3)-ST(3,3)*VPba(2,2)*s(1))*EQQQ(5,3,7)...
        + (-ST(1,2)*VPba(2,1)*s(2))*EQQQ(5,6,6) +(ST(1,2)*VPba(2,1)*s(3))*EQQQ(5,6,8)...
        + (-ST(1,3)*VPba(1,3)*s(1))*EQQQ(9,2,2) +(ST(1,3)*VPba(1,3)*s(2))*EQQQ(9,2,4)...
        + (ST(1,3)*VPba(3,1)*s(3))*EQQQ(9,6,6) +(-ST(1,3)*VPba(3,1)*s(2))*EQQQ(9,6,8)...
        + (ST(1,1)*VPba(3,3)*s(2)-ST(1,2)*VPba(1,2)*s(3)+ST(3,3)*VPba(1,1)*s(2)-ST(3,2)*VPba(3,2)*s(1))*EQQQ(2,6,7)...
        + (ST(3,3)*VPba(3,3)*s(1)-ST(3,3)*VPba(1,1)*s(3))*EQQQ(4,3,6)...
        + (ST(1,2)*VPba(1,2)*s(1)-ST(1,1)*VPba(1,1)*s(2)+ST(3,2)*VPba(3,2)*s(3)-ST(3,3)*VPba(3,3)*s(2))*EQQQ(2,6,3)...
        + (ST(1,1)*VPba(1,1)*s(3)-ST(1,1)*VPba(3,3)*s(1))*EQQQ(3,8,2);
    ERPbavRvRdRpt(2,3) = (-ST(2,1)*VPba(1,3)*s(1))*EQQQ(1,2,2) +(ST(2,1)*VPba(1,3)*s(2))*EQQQ(1,2,4)...
        + (ST(2,1)*VPba(3,1)*s(3))*EQQQ(1,6,6) +(-ST(2,1)*VPba(3,1)*s(2))*EQQQ(1,6,8)...
        + (ST(1,2)*VPba(1,3)*s(1)+ST(1,1)*VPba(2,3)*s(1)+ST(2,2)*VPba(2,3)*s(2))*EQQQ(5,2,2)...
        + (-ST(1,2)*VPba(1,3)*s(2)-ST(1,1)*VPba(2,3)*s(2)-ST(2,2)*VPba(2,3)*s(1))*EQQQ(5,2,4)...
        + (-ST(2,3)*VPba(2,2)*s(3))*EQQQ(5,3,3) +(ST(2,3)*VPba(2,2)*s(1))*EQQQ(5,3,7)...
        + (-ST(1,3)*VPba(2,1)*s(3)-ST(1,2)*VPba(3,1)*s(3))*EQQQ(5,6,6)...
        + (ST(1,3)*VPba(2,1)*s(2)+ST(1,2)*VPba(3,1)*s(2))*EQQQ(5,6,8)...
        + (ST(2,2)*VPba(3,2)*s(1)-ST(2,3)*VPba(1,1)*s(2))*EQQQ(2,6,7)...
        + (ST(1,3)*VPba(1,2)*s(3)+ST(2,3)*VPba(1,1)*s(3)+ST(1,1)*VPba(3,2)*s(3)-ST(2,3)*VPba(3,3)*s(1))*EQQQ(4,3,6)...
        + (ST(2,3)*VPba(3,3)*s(2)-ST(2,2)*VPba(3,2)*s(3))*EQQQ(2,6,3)...
        + (-ST(1,3)*VPba(1,2)*s(1)-ST(1,1)*VPba(3,2)*s(1))*EQQQ(3,8,2);
    ERPbavRvRdRpt(3,1) = (ST(3,2)*VPba(1,2)*s(1))*EQQQ(5,3,3) +(-ST(3,2)*VPba(1,2)*s(3))*EQQQ(5,3,7)...
        + (-ST(3,2)*VPba(2,1)*s(2))*EQQQ(5,6,6) +(ST(3,2)*VPba(2,1)*s(3))*EQQQ(5,6,8)...
        + (-ST(3,1)*VPba(3,3)*s(1))*EQQQ(9,2,2) +(ST(3,1)*VPba(3,3)*s(2))*EQQQ(9,2,4)...
        + (-ST(2,3)*VPba(1,2)*s(1)-ST(2,1)*VPba(3,2)*s(1))*EQQQ(9,3,3)...
        + (ST(2,3)*VPba(1,2)*s(3)+ST(2,1)*VPba(3,2)*s(3))*EQQQ(9,3,7)...
        + (ST(2,3)*VPba(2,1)*s(2)+ST(2,2)*VPba(3,1)*s(2)+ST(3,3)*VPba(3,1)*s(3))*EQQQ(9,6,6)...
        + (-ST(2,3)*VPba(2,1)*s(3)-ST(2,2)*VPba(3,1)*s(3)-ST(3,3)*VPba(3,1)*s(2))*EQQQ(9,6,8)...
        + (ST(3,3)*VPba(1,3)*s(2)-ST(3,1)*VPba(2,2)*s(3))*EQQQ(2,6,7)...
        + (-ST(2,2)*VPba(1,3)*s(2)-ST(2,1)*VPba(2,3)*s(2))*EQQQ(4,3,6)...
        + (ST(2,2)*VPba(1,3)*s(1)-ST(3,1)*VPba(1,1)*s(2)+ST(2,1)*VPba(2,3)*s(1)+ST(3,1)*VPba(2,2)*s(1))*EQQQ(2,6,3)...
        + (ST(3,1)*VPba(1,1)*s(3)-ST(3,3)*VPba(1,3)*s(1))*EQQQ(3,8,2);
    ERPbavRvRdRpt(3,2) = (-ST(3,1)*VPba(1,2)*s(1))*EQQQ(1,3,3) +(ST(3,1)*VPba(1,2)*s(3))*EQQQ(1,3,7)...
        + (ST(3,1)*VPba(2,1)*s(2))*EQQQ(1,6,6) +(-ST(3,1)*VPba(2,1)*s(3))*EQQQ(1,6,8)...
        + (-ST(3,2)*VPba(3,3)*s(2))*EQQQ(9,2,2) +(ST(3,2)*VPba(3,3)*s(1))*EQQQ(9,2,4)...
        + (ST(1,3)*VPba(1,2)*s(1)+ST(1,1)*VPba(3,2)*s(1)+ST(3,3)*VPba(3,2)*s(3))*EQQQ(9,3,3)...
        + (-ST(1,3)*VPba(1,2)*s(3)-ST(1,1)*VPba(3,2)*s(3)-ST(3,3)*VPba(3,2)*s(1))*EQQQ(9,3,7)...
        + (-ST(1,3)*VPba(2,1)*s(2)-ST(1,2)*VPba(3,1)*s(2))*EQQQ(9,6,6)...
        + (ST(1,3)*VPba(2,1)*s(3)+ST(1,2)*VPba(3,1)*s(3))*EQQQ(9,6,8)...
        + (ST(3,3)*VPba(2,3)*s(1)-ST(3,2)*VPba(1,1)*s(3))*EQQQ(2,6,7)...
        + (ST(1,2)*VPba(1,3)*s(2)+ST(1,1)*VPba(2,3)*s(2)+ST(3,2)*VPba(1,1)*s(2)-ST(3,2)*VPba(2,2)*s(1))*EQQQ(4,3,6)...
        + (-ST(1,2)*VPba(1,3)*s(1)-ST(1,1)*VPba(2,3)*s(1))*EQQQ(2,6,3)...
        + (ST(3,2)*VPba(2,2)*s(3)-ST(3,3)*VPba(2,3)*s(2))*EQQQ(3,8,2);
    ERPbavRvRdRpt(3,3) = (ST(2,1)*VPba(1,2)*s(1))*EQQQ(1,3,3) +(-ST(2,1)*VPba(1,2)*s(3))*EQQQ(1,3,7)...
        + (-ST(2,1)*VPba(2,1)*s(2))*EQQQ(1,6,6) +(ST(2,1)*VPba(2,1)*s(3))*EQQQ(1,6,8)...
        + (-ST(1,2)*VPba(1,2)*s(1))*EQQQ(5,3,3) +(ST(1,2)*VPba(1,2)*s(3))*EQQQ(5,3,7)...
        + (ST(1,2)*VPba(2,1)*s(2))*EQQQ(5,6,6) +(-ST(1,2)*VPba(2,1)*s(3))*EQQQ(5,6,8)...
        + (ST(1,1)*VPba(3,3)*s(1)+ST(2,2)*VPba(3,3)*s(2))*EQQQ(9,2,2)...
        + (-ST(1,1)*VPba(3,3)*s(2)-ST(2,2)*VPba(3,3)*s(1))*EQQQ(9,2,4)...
        + (-ST(2,3)*VPba(3,2)*s(3))*EQQQ(9,3,3) +(ST(2,3)*VPba(3,2)*s(1))*EQQQ(9,3,7)...
        + (-ST(1,3)*VPba(3,1)*s(3))*EQQQ(9,6,6) +(ST(1,3)*VPba(3,1)*s(2))*EQQQ(9,6,8)...
        + (ST(1,1)*VPba(2,2)*s(3)-ST(1,3)*VPba(1,3)*s(2)+ST(2,2)*VPba(1,1)*s(3)-ST(2,3)*VPba(2,3)*s(1))*EQQQ(2,6,7)...
        + (ST(2,2)*VPba(2,2)*s(1)-ST(2,2)*VPba(1,1)*s(2))*EQQQ(4,3,6)...
        + (ST(1,1)*VPba(1,1)*s(2)-ST(1,1)*VPba(2,2)*s(1))*EQQQ(2,6,3)...
        + (ST(1,3)*VPba(1,3)*s(1)-ST(1,1)*VPba(1,1)*s(3)-ST(2,2)*VPba(2,2)*s(3)+ST(2,3)*VPba(2,3)*s(2))*EQQQ(3,8,2);
    ERPbavRvRdRpt = U*ERPbavRvRdRpt*UT';
else
    ERPbavRvRdRpt(1,1) = (-ST(1,3)*VPba(1,3)*s(1))*EQQQ(1,2,2) +(ST(1,3)*VPba(1,3)*s(2))*EQQQ(1,2,4)...
        + (-ST(1,2)*VPba(1,2)*s(1))*EQQQ(1,3,3) +(ST(1,2)*VPba(1,2)*s(3))*EQQQ(1,3,7)...
        + (ST(2,2)*VPba(1,1)*s(2)+ST(3,3)*VPba(1,1)*s(3))*EQQQ(1,6,6)...
        + (-ST(2,2)*VPba(1,1)*s(3)-ST(3,3)*VPba(1,1)*s(2))*EQQQ(1,6,8)...
        + (-ST(2,3)*VPba(2,3)*s(1))*EQQQ(5,2,2) +(ST(2,3)*VPba(2,3)*s(2))*EQQQ(5,2,4)...
        + (ST(2,3)*VPba(3,2)*s(1))*EQQQ(5,3,3) +(-ST(2,3)*VPba(3,2)*s(3))*EQQQ(5,3,7)...
        + (ST(3,2)*VPba(2,3)*s(1))*EQQQ(9,2,2) +(-ST(3,2)*VPba(2,3)*s(2))*EQQQ(9,2,4)...
        + (-ST(3,2)*VPba(3,2)*s(1))*EQQQ(9,3,3) +(ST(3,2)*VPba(3,2)*s(3))*EQQQ(9,3,7)...
        + (ST(2,2)*VPba(2,2)*s(3)+ST(3,3)*VPba(3,3)*s(2))*EQQQ(2,6,7)...
        + (-ST(2,2)*VPba(3,3)*s(2)-ST(3,3)*VPba(2,2)*s(3))*EQQQ(4,3,6)...
        + (ST(1,2)*VPba(2,1)*s(2)-ST(2,2)*VPba(2,2)*s(1)-ST(1,3)*VPba(3,1)*s(2)+ST(2,2)*VPba(3,3)*s(1))*EQQQ(2,6,3)...
        + (ST(1,3)*VPba(3,1)*s(3)-ST(1,2)*VPba(2,1)*s(3)+ST(3,3)*VPba(2,2)*s(1)-ST(3,3)*VPba(3,3)*s(1))*EQQQ(3,8,2);
    ERPbavRvRdRpt(1,2) = (ST(1,3)*VPba(2,3)*s(1)-ST(2,3)*VPba(1,3)*s(2))*EQQQ(1,2,2)...
        + (ST(2,3)*VPba(1,3)*s(1)-ST(1,3)*VPba(2,3)*s(2))*EQQQ(1,2,4)...
        + (ST(1,1)*VPba(1,2)*s(1)-ST(1,3)*VPba(3,2)*s(1)+ST(3,3)*VPba(1,2)*s(3))*EQQQ(1,3,3)...
        + (ST(1,3)*VPba(3,2)*s(3)-ST(3,3)*VPba(1,2)*s(1)-ST(1,1)*VPba(1,2)*s(3))*EQQQ(1,3,7)...
        + (-ST(2,1)*VPba(1,1)*s(2))*EQQQ(1,6,6) +(ST(2,1)*VPba(1,1)*s(3))*EQQQ(1,6,8)...
        + (-ST(3,1)*VPba(2,3)*s(1))*EQQQ(9,2,2) +(ST(3,1)*VPba(2,3)*s(2))*EQQQ(9,2,4)...
        + (ST(3,1)*VPba(3,2)*s(1))*EQQQ(9,3,3) +(-ST(3,1)*VPba(3,2)*s(3))*EQQQ(9,3,7)...
        + (ST(3,3)*VPba(2,1)*s(2)-ST(2,1)*VPba(2,2)*s(3)-ST(2,3)*VPba(3,1)*s(3))*EQQQ(2,6,7)...
        + (ST(2,1)*VPba(3,3)*s(2)+ST(2,3)*VPba(3,1)*s(2)-ST(3,3)*VPba(2,1)*s(3))*EQQQ(4,3,6)...
        + (ST(2,1)*VPba(2,2)*s(1)-ST(1,1)*VPba(2,1)*s(2)-ST(2,1)*VPba(3,3)*s(1))*EQQQ(2,6,3)...
        + (ST(1,1)*VPba(2,1)*s(3))*EQQQ(3,8,2);
    ERPbavRvRdRpt(1,3) = (ST(1,1)*VPba(1,3)*s(1)-ST(1,2)*VPba(2,3)*s(1)+ST(2,2)*VPba(1,3)*s(2))*EQQQ(1,2,2)...
        + (ST(1,2)*VPba(2,3)*s(2)-ST(2,2)*VPba(1,3)*s(1)-ST(1,1)*VPba(1,3)*s(2))*EQQQ(1,2,4)...
        + (ST(1,2)*VPba(3,2)*s(1)-ST(3,2)*VPba(1,2)*s(3))*EQQQ(1,3,3)...
        + (ST(3,2)*VPba(1,2)*s(1)-ST(1,2)*VPba(3,2)*s(3))*EQQQ(1,3,7)...
        + (-ST(3,1)*VPba(1,1)*s(3))*EQQQ(1,6,6) +(ST(3,1)*VPba(1,1)*s(2))*EQQQ(1,6,8)...
        + (ST(2,1)*VPba(2,3)*s(1))*EQQQ(5,2,2) +(-ST(2,1)*VPba(2,3)*s(2))*EQQQ(5,2,4)...
        + (-ST(2,1)*VPba(3,2)*s(1))*EQQQ(5,3,3) +(ST(2,1)*VPba(3,2)*s(3))*EQQQ(5,3,7)...
        + (ST(2,2)*VPba(3,1)*s(3)-ST(3,2)*VPba(2,1)*s(2)-ST(3,1)*VPba(3,3)*s(2))*EQQQ(2,6,7)...
        + (ST(3,1)*VPba(2,2)*s(3)-ST(2,2)*VPba(3,1)*s(2)+ST(3,2)*VPba(2,1)*s(3))*EQQQ(4,3,6)...
        + (ST(1,1)*VPba(3,1)*s(2))*EQQQ(2,6,3)...
        + (ST(3,1)*VPba(3,3)*s(1)-ST(3,1)*VPba(2,2)*s(1)-ST(1,1)*VPba(3,1)*s(3))*EQQQ(3,8,2);
    ERPbavRvRdRpt(2,1) = (ST(2,3)*VPba(1,3)*s(2)-ST(1,3)*VPba(2,3)*s(1))*EQQQ(5,2,2)...
        + (ST(1,3)*VPba(2,3)*s(2)-ST(2,3)*VPba(1,3)*s(1))*EQQQ(5,2,4)...
        + (-ST(1,2)*VPba(2,2)*s(1))*EQQQ(5,3,3) +(ST(1,2)*VPba(2,2)*s(3))*EQQQ(5,3,7)...
        + (ST(2,2)*VPba(2,1)*s(2)-ST(2,3)*VPba(3,1)*s(2)+ST(3,3)*VPba(2,1)*s(3))*EQQQ(5,6,6)...
        + (ST(2,3)*VPba(3,1)*s(3)-ST(3,3)*VPba(2,1)*s(2)-ST(2,2)*VPba(2,1)*s(3))*EQQQ(5,6,8)...
        + (-ST(3,2)*VPba(1,3)*s(2))*EQQQ(9,2,2) +(ST(3,2)*VPba(1,3)*s(1))*EQQQ(9,2,4)...
        + (ST(3,2)*VPba(3,1)*s(2))*EQQQ(9,6,6) +(-ST(3,2)*VPba(3,1)*s(3))*EQQQ(9,6,8)...
        + (ST(3,3)*VPba(1,2)*s(1)-ST(1,2)*VPba(1,1)*s(3)-ST(1,3)*VPba(3,2)*s(3))*EQQQ(2,6,7)...
        + (ST(1,2)*VPba(1,1)*s(2)-ST(2,2)*VPba(1,2)*s(1)-ST(1,2)*VPba(3,3)*s(2))*EQQQ(4,3,6)...
        + (ST(1,2)*VPba(3,3)*s(1)+ST(1,3)*VPba(3,2)*s(1)-ST(3,3)*VPba(1,2)*s(3))*EQQQ(2,6,3)...
        + (ST(2,2)*VPba(1,2)*s(3))*EQQQ(3,8,2);
    ERPbavRvRdRpt(2,2) = (-ST(1,3)*VPba(1,3)*s(2))*EQQQ(1,2,2) +(ST(1,3)*VPba(1,3)*s(1))*EQQQ(1,2,4)...
        + (ST(1,3)*VPba(3,1)*s(2))*EQQQ(1,6,6) +(-ST(1,3)*VPba(3,1)*s(3))*EQQQ(1,6,8)...
        + (-ST(2,3)*VPba(2,3)*s(2))*EQQQ(5,2,2) +(ST(2,3)*VPba(2,3)*s(1))*EQQQ(5,2,4)...
        + (ST(1,1)*VPba(2,2)*s(1)+ST(3,3)*VPba(2,2)*s(3))*EQQQ(5,3,3)...
        + (-ST(1,1)*VPba(2,2)*s(3)-ST(3,3)*VPba(2,2)*s(1))*EQQQ(5,3,7)...
        + (-ST(2,1)*VPba(2,1)*s(2))*EQQQ(5,6,6) +(ST(2,1)*VPba(2,1)*s(3))*EQQQ(5,6,8)...
        + (ST(3,1)*VPba(1,3)*s(2))*EQQQ(9,2,2) +(-ST(3,1)*VPba(1,3)*s(1))*EQQQ(9,2,4)...
        + (-ST(3,1)*VPba(3,1)*s(2))*EQQQ(9,6,6) +(ST(3,1)*VPba(3,1)*s(3))*EQQQ(9,6,8)...
        + (ST(1,1)*VPba(1,1)*s(3)+ST(3,3)*VPba(3,3)*s(1))*EQQQ(2,6,7)...
        + (ST(2,1)*VPba(1,2)*s(1)-ST(1,1)*VPba(1,1)*s(2)+ST(1,1)*VPba(3,3)*s(2)-ST(2,3)*VPba(3,2)*s(1))*EQQQ(4,3,6)...
        + (-ST(1,1)*VPba(3,3)*s(1)-ST(3,3)*VPba(1,1)*s(3))*EQQQ(2,6,3)...
        + (ST(3,3)*VPba(1,1)*s(2)-ST(2,1)*VPba(1,2)*s(3)+ST(2,3)*VPba(3,2)*s(3)-ST(3,3)*VPba(3,3)*s(2))*EQQQ(3,8,2);
    ERPbavRvRdRpt(2,3) = (ST(1,2)*VPba(1,3)*s(2))*EQQQ(1,2,2) +(-ST(1,2)*VPba(1,3)*s(1))*EQQQ(1,2,4)...
        + (-ST(1,2)*VPba(3,1)*s(2))*EQQQ(1,6,6) +(ST(1,2)*VPba(3,1)*s(3))*EQQQ(1,6,8)...
        + (ST(1,1)*VPba(2,3)*s(1)-ST(2,1)*VPba(1,3)*s(2)+ST(2,2)*VPba(2,3)*s(2))*EQQQ(5,2,2)...
        + (ST(2,1)*VPba(1,3)*s(1)-ST(1,1)*VPba(2,3)*s(2)-ST(2,2)*VPba(2,3)*s(1))*EQQQ(5,2,4)...
        + (-ST(3,2)*VPba(2,2)*s(3))*EQQQ(5,3,3) +(ST(3,2)*VPba(2,2)*s(1))*EQQQ(5,3,7)...
        + (ST(2,1)*VPba(3,1)*s(2)-ST(3,1)*VPba(2,1)*s(3))*EQQQ(5,6,6)...
        + (ST(3,1)*VPba(2,1)*s(2)-ST(2,1)*VPba(3,1)*s(3))*EQQQ(5,6,8)...
        + (ST(1,1)*VPba(3,2)*s(3)-ST(3,1)*VPba(1,2)*s(1)-ST(3,2)*VPba(3,3)*s(1))*EQQQ(2,6,7)...
        + (ST(2,2)*VPba(3,2)*s(1))*EQQQ(4,3,6)...
        + (ST(3,1)*VPba(1,2)*s(3)-ST(1,1)*VPba(3,2)*s(1)+ST(3,2)*VPba(1,1)*s(3))*EQQQ(2,6,3)...
        + (ST(3,2)*VPba(3,3)*s(2)-ST(2,2)*VPba(3,2)*s(3)-ST(3,2)*VPba(1,1)*s(2))*EQQQ(3,8,2);
    ERPbavRvRdRpt(3,1) = (-ST(2,3)*VPba(1,2)*s(3))*EQQQ(5,3,3) +(ST(2,3)*VPba(1,2)*s(1))*EQQQ(5,3,7)...
        + (ST(2,3)*VPba(2,1)*s(3))*EQQQ(5,6,6) +(-ST(2,3)*VPba(2,1)*s(2))*EQQQ(5,6,8)...
        + (-ST(1,3)*VPba(3,3)*s(1))*EQQQ(9,2,2) +(ST(1,3)*VPba(3,3)*s(2))*EQQQ(9,2,4)...
        + (ST(3,2)*VPba(1,2)*s(3)-ST(1,2)*VPba(3,2)*s(1))*EQQQ(9,3,3)...
        + (ST(1,2)*VPba(3,2)*s(3)-ST(3,2)*VPba(1,2)*s(1))*EQQQ(9,3,7)...
        + (ST(2,2)*VPba(3,1)*s(2)-ST(3,2)*VPba(2,1)*s(3)+ST(3,3)*VPba(3,1)*s(3))*EQQQ(9,6,6)...
        + (ST(3,2)*VPba(2,1)*s(2)-ST(2,2)*VPba(3,1)*s(3)-ST(3,3)*VPba(3,1)*s(2))*EQQQ(9,6,8)...
        + (ST(2,2)*VPba(1,3)*s(1)-ST(1,3)*VPba(1,1)*s(2)-ST(1,2)*VPba(2,3)*s(2))*EQQQ(2,6,7)...
        + (ST(1,3)*VPba(1,1)*s(3)-ST(1,3)*VPba(2,2)*s(3)-ST(3,3)*VPba(1,3)*s(1))*EQQQ(4,3,6)...
        + (ST(3,3)*VPba(1,3)*s(2))*EQQQ(2,6,3)...
        + (ST(1,2)*VPba(2,3)*s(1)+ST(1,3)*VPba(2,2)*s(1)-ST(2,2)*VPba(1,3)*s(2))*EQQQ(3,8,2);
    ERPbavRvRdRpt(3,2) = (ST(1,3)*VPba(1,2)*s(3))*EQQQ(1,3,3) +(-ST(1,3)*VPba(1,2)*s(1))*EQQQ(1,3,7)...
        + (-ST(1,3)*VPba(2,1)*s(3))*EQQQ(1,6,6) +(ST(1,3)*VPba(2,1)*s(2))*EQQQ(1,6,8)...
        + (-ST(2,3)*VPba(3,3)*s(2))*EQQQ(9,2,2) +(ST(2,3)*VPba(3,3)*s(1))*EQQQ(9,2,4)...
        + (ST(1,1)*VPba(3,2)*s(1)-ST(3,1)*VPba(1,2)*s(3)+ST(3,3)*VPba(3,2)*s(3))*EQQQ(9,3,3)...
        + (ST(3,1)*VPba(1,2)*s(1)-ST(1,1)*VPba(3,2)*s(3)-ST(3,3)*VPba(3,2)*s(1))*EQQQ(9,3,7)...
        + (ST(3,1)*VPba(2,1)*s(3)-ST(2,1)*VPba(3,1)*s(2))*EQQQ(9,6,6)...
        + (ST(2,1)*VPba(3,1)*s(3)-ST(3,1)*VPba(2,1)*s(2))*EQQQ(9,6,8)...
        + (ST(1,1)*VPba(2,3)*s(2)-ST(2,1)*VPba(1,3)*s(1)-ST(2,3)*VPba(2,2)*s(1))*EQQQ(2,6,7)...
        + (ST(3,3)*VPba(2,3)*s(1))*EQQQ(4,3,6)...
        + (ST(2,3)*VPba(2,2)*s(3)-ST(2,3)*VPba(1,1)*s(3)-ST(3,3)*VPba(2,3)*s(2))*EQQQ(2,6,3)...
        + (ST(2,1)*VPba(1,3)*s(2)-ST(1,1)*VPba(2,3)*s(1)+ST(2,3)*VPba(1,1)*s(2))*EQQQ(3,8,2);
    ERPbavRvRdRpt(3,3) = (-ST(1,2)*VPba(1,2)*s(3))*EQQQ(1,3,3) +(ST(1,2)*VPba(1,2)*s(1))*EQQQ(1,3,7)...
        + (ST(1,2)*VPba(2,1)*s(3))*EQQQ(1,6,6) +(-ST(1,2)*VPba(2,1)*s(2))*EQQQ(1,6,8)...
        + (ST(2,1)*VPba(1,2)*s(3))*EQQQ(5,3,3) +(-ST(2,1)*VPba(1,2)*s(1))*EQQQ(5,3,7)...
        + (-ST(2,1)*VPba(2,1)*s(3))*EQQQ(5,6,6) +(ST(2,1)*VPba(2,1)*s(2))*EQQQ(5,6,8)...
        + (ST(1,1)*VPba(3,3)*s(1)+ST(2,2)*VPba(3,3)*s(2))*EQQQ(9,2,2)...
        + (-ST(1,1)*VPba(3,3)*s(2)-ST(2,2)*VPba(3,3)*s(1))*EQQQ(9,2,4)...
        + (-ST(3,2)*VPba(3,2)*s(3))*EQQQ(9,3,3) +(ST(3,2)*VPba(3,2)*s(1))*EQQQ(9,3,7)...
        + (-ST(3,1)*VPba(3,1)*s(3))*EQQQ(9,6,6) +(ST(3,1)*VPba(3,1)*s(2))*EQQQ(9,6,8)...
        + (ST(1,1)*VPba(1,1)*s(2)+ST(2,2)*VPba(2,2)*s(1))*EQQQ(2,6,7)...
        + (ST(1,1)*VPba(2,2)*s(3)-ST(1,1)*VPba(1,1)*s(3)+ST(3,1)*VPba(1,3)*s(1)-ST(3,2)*VPba(2,3)*s(1))*EQQQ(4,3,6)...
        + (ST(2,2)*VPba(1,1)*s(3)-ST(3,1)*VPba(1,3)*s(2)-ST(2,2)*VPba(2,2)*s(3)+ST(3,2)*VPba(2,3)*s(2))*EQQQ(2,6,3)...
        + (-ST(1,1)*VPba(2,2)*s(1)-ST(2,2)*VPba(1,1)*s(2))*EQQQ(3,8,2);
    ERPbavRvRdRpt = U*ERPbavRvRdRpt*VT';
end

EbgvRdRptdt = EbgvRdRpt;
EpvRdRptdt = EpvRdRpt + dt*EvvRdRpt;
EvvRdRptdt = EvvRdRpt + dt*ERavRdRpt + dt*ERPbavRvRdRpt - dt*g*EvRdRpt';
EbavRdRptdt = EbavRdRpt;

ExvRdRptdt = [EbgvRdRptdt;EpvRdRptdt;EvvRdRptdt;EbavRdRptdt];

% ExvRhatbdRptdt
if defQS
    EGQt = [ST(2,2)*EQ(3,3)+ST(3,3)*EQ(2,2), -ST(1,2)*EQ(3,3), -ST(1,3)*EQ(2,2);
          -ST(2,1)*EQ(3,3), ST(1,1)*EQ(3,3)+ST(3,3)*EQ(1,1), -ST(2,3)*EQ(1,1);
          -ST(3,1)*EQ(2,2), -ST(3,2)*EQ(1,1), ST(1,1)*EQ(2,2)+ST(2,2)*EQ(1,1)];
else
    EGQt = [ST(2,2)*EQ(2,2)+ST(3,3)*EQ(3,3), -ST(1,2)*EQ(1,1), -ST(1,3)*EQ(1,1);
            -ST(2,1)*EQ(2,2), ST(1,1)*EQ(1,1)+ST(3,3)*EQ(3,3), -ST(2,3)*EQ(2,2);
            -ST(3,1)*EQ(3,3), -ST(3,2)*EQ(3,3), ST(1,1)*EQ(1,1)+ST(2,2)*EQ(2,2)];
end

PV = Pbg'*V;
if defQS
    EvRPbgVGQt(1) = (PV(3,3)*ST(3,2)+PV(2,3)*ST(2,2)-PV(3,2)*ST(3,3)-PV(2,2)*ST(2,3))*EQ(1,1)...
        +(PV(1,3)*ST(2,1)-PV(1,1)*ST(2,3))*EQ(2,2)+(PV(1,1)*ST(3,2)-PV(1,2)*ST(3,1))*EQ(3,3);
    EvRPbgVGQt(2) = (PV(1,1)*ST(1,3)+PV(3,1)*ST(3,3)-PV(1,3)*ST(1,1)-PV(3,3)*ST(3,1))*EQ(2,2)...
        +(PV(2,1)*ST(3,2)-PV(2,2)*ST(3,1))*EQ(3,3)+(PV(2,2)*ST(1,3)-PV(2,3)*ST(1,2))*EQ(1,1);
    EvRPbgVGQt(3) = (PV(2,2)*ST(2,1)+PV(1,2)*ST(1,1)-PV(2,1)*ST(2,2)-PV(1,1)*ST(1,2))*EQ(3,3)...
        +(PV(3,2)*ST(1,3)-PV(3,3)*ST(1,2))*EQ(1,1)+(PV(3,3)*ST(2,1)-PV(3,1)*ST(2,3))*EQ(2,2);
else
    EvRPbgVGQt(1) = (PV(2,1)*ST(1,3)-PV(3,1)*ST(1,2))*EQ(1,1)...
        -(PV(3,2)*ST(2,2)+PV(3,3)*ST(2,3)+PV(1,1)*ST(2,3))*EQ(2,2)...
        +(PV(2,2)*ST(3,2)+PV(2,3)*ST(3,3)+PV(1,1)*ST(3,2))*EQ(3,3);
    EvRPbgVGQt(2) = (PV(3,2)*ST(2,1)-PV(1,2)*ST(2,3))*EQ(2,2)...
        +(PV(3,1)*ST(1,1)+PV(3,3)*ST(1,3)+PV(2,2)*ST(1,3))*EQ(1,1)...
        -(PV(1,1)*ST(3,1)+PV(1,3)*ST(3,3)+PV(2,2)*ST(3,1))*EQ(3,3);
    EvRPbgVGQt(3) = (PV(1,3)*ST(3,2)-PV(2,3)*ST(3,1))*EQ(3,3)...
        -(PV(2,1)*ST(1,1)+PV(2,2)*ST(1,2)+PV(3,3)*ST(1,2))*EQ(1,1)...
        +(PV(1,1)*ST(2,1)+PV(1,2)*ST(2,2)+PV(3,3)*ST(2,1))*EQ(2,2);
end

if defQS
    EvRvRPbgVGQt(1,1) = (PV(1,1)*ST(3,3)*s(2)^2-PV(1,3)*ST(3,1)*s(2)^2+PV(1,1)*ST(3,3)*s(3)^2-PV(1,3)*ST(3,1)*s(3)^2)*EQQQ(5,6,6)...
        +(2*PV(1,3)*ST(3,1)*s(2)*s(3)-2*PV(1,1)*ST(3,3)*s(2)*s(3))*EQQQ(5,6,8)...
        +(PV(1,1)*ST(2,2)*s(2)^2-PV(1,2)*ST(2,1)*s(2)^2+PV(1,1)*ST(2,2)*s(3)^2-PV(1,2)*ST(2,1)*s(3)^2)*EQQQ(9,6,6)...
        +(2*PV(1,2)*ST(2,1)*s(2)*s(3)-2*PV(1,1)*ST(2,2)*s(2)*s(3))*EQQQ(9,6,8)...
        +(PV(2,3)*ST(3,2)*s(2)*s(3)-PV(2,2)*ST(3,3)*s(2)*s(3)+PV(3,2)*ST(2,3)*s(2)*s(3)-PV(3,3)*ST(2,2)*s(2)*s(3))*EQQQ(2,6,7)...
        +(PV(3,3)*ST(2,2)*s(2)^2-PV(3,2)*ST(2,3)*s(2)^2+PV(2,2)*ST(3,3)*s(3)^2-PV(2,3)*ST(3,2)*s(3)^2)*EQQQ(4,3,6)...
        +(PV(2,2)*ST(3,3)*s(1)*s(2)-PV(2,3)*ST(3,2)*s(1)*s(2)+PV(3,2)*ST(2,3)*s(1)*s(2)-PV(3,3)*ST(2,2)*s(1)*s(2))*EQQQ(2,6,3)...
        +(PV(2,3)*ST(3,2)*s(1)*s(3)-PV(2,2)*ST(3,3)*s(1)*s(3)-PV(3,2)*ST(2,3)*s(1)*s(3)+PV(3,3)*ST(2,2)*s(1)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(1,2) = (PV(1,2)*ST(3,3)*s(2)^2-PV(1,3)*ST(3,2)*s(2)^2+PV(1,2)*ST(3,3)*s(3)^2-PV(1,3)*ST(3,2)*s(3)^2)*EQQQ(1,6,6)...
        +(2*PV(1,3)*ST(3,2)*s(2)*s(3)-2*PV(1,2)*ST(3,3)*s(2)*s(3))*EQQQ(1,6,8)...
        +(PV(1,2)*ST(1,1)*s(2)^2-PV(1,1)*ST(1,2)*s(2)^2-PV(1,1)*ST(1,2)*s(3)^2+PV(1,2)*ST(1,1)*s(3)^2)*EQQQ(9,6,6)...
        +(2*PV(1,1)*ST(1,2)*s(2)*s(3)-2*PV(1,2)*ST(1,1)*s(2)*s(3))*EQQQ(9,6,8)...
        +(PV(3,3)*ST(1,2)*s(2)*s(3)-PV(3,2)*ST(1,3)*s(2)*s(3)-PV(2,1)*ST(3,3)*s(1)*s(3)+PV(2,3)*ST(3,1)*s(1)*s(3)+PV(3,1)*ST(3,2)*s(1)*s(2)-PV(3,2)*ST(3,1)*s(1)*s(2))*EQQQ(2,6,7)...
        +(PV(3,2)*ST(1,3)*s(2)^2-PV(3,3)*ST(1,2)*s(2)^2+PV(2,1)*ST(3,3)*s(1)*s(2)-PV(2,3)*ST(3,1)*s(1)*s(2)-PV(3,1)*ST(3,2)*s(1)*s(3)+PV(3,2)*ST(3,1)*s(1)*s(3))*EQQQ(4,3,6)...
        +(PV(2,1)*ST(3,3)*s(3)^2-PV(2,3)*ST(3,1)*s(3)^2-PV(3,2)*ST(1,3)*s(1)*s(2)+PV(3,3)*ST(1,2)*s(1)*s(2)+PV(3,1)*ST(3,2)*s(2)*s(3)-PV(3,2)*ST(3,1)*s(2)*s(3))*EQQQ(2,6,3)...
        +(PV(3,2)*ST(3,1)*s(2)^2-PV(3,1)*ST(3,2)*s(2)^2+PV(3,2)*ST(1,3)*s(1)*s(3)-PV(3,3)*ST(1,2)*s(1)*s(3)-PV(2,1)*ST(3,3)*s(2)*s(3)+PV(2,3)*ST(3,1)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(1,3) = (PV(1,3)*ST(2,2)*s(2)^2-PV(1,2)*ST(2,3)*s(2)^2-PV(1,2)*ST(2,3)*s(3)^2+PV(1,3)*ST(2,2)*s(3)^2)*EQQQ(1,6,6)...
        +(2*PV(1,2)*ST(2,3)*s(2)*s(3)-2*PV(1,3)*ST(2,2)*s(2)*s(3))*EQQQ(1,6,8)...
        +(PV(1,3)*ST(1,1)*s(2)^2-PV(1,1)*ST(1,3)*s(2)^2-PV(1,1)*ST(1,3)*s(3)^2+PV(1,3)*ST(1,1)*s(3)^2)*EQQQ(5,6,6)...
        +(2*PV(1,1)*ST(1,3)*s(2)*s(3)-2*PV(1,3)*ST(1,1)*s(2)*s(3))*EQQQ(5,6,8)...
        +(PV(2,2)*ST(1,3)*s(2)*s(3)-PV(2,3)*ST(1,2)*s(2)*s(3)+PV(2,1)*ST(2,3)*s(1)*s(3)-PV(2,3)*ST(2,1)*s(1)*s(3)-PV(3,1)*ST(2,2)*s(1)*s(2)+PV(3,2)*ST(2,1)*s(1)*s(2))*EQQQ(2,6,7)...
        +(PV(2,3)*ST(1,2)*s(3)^2-PV(2,2)*ST(1,3)*s(3)^2-PV(2,1)*ST(2,3)*s(1)*s(2)+PV(2,3)*ST(2,1)*s(1)*s(2)+PV(3,1)*ST(2,2)*s(1)*s(3)-PV(3,2)*ST(2,1)*s(1)*s(3))*EQQQ(4,3,6)...
        +(PV(2,3)*ST(2,1)*s(3)^2-PV(2,1)*ST(2,3)*s(3)^2-PV(2,2)*ST(1,3)*s(1)*s(2)+PV(2,3)*ST(1,2)*s(1)*s(2)-PV(3,1)*ST(2,2)*s(2)*s(3)+PV(3,2)*ST(2,1)*s(2)*s(3))*EQQQ(2,6,3)...
        +(PV(3,1)*ST(2,2)*s(2)^2-PV(3,2)*ST(2,1)*s(2)^2+PV(2,2)*ST(1,3)*s(1)*s(3)-PV(2,3)*ST(1,2)*s(1)*s(3)+PV(2,1)*ST(2,3)*s(2)*s(3)-PV(2,3)*ST(2,1)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(2,1) = (PV(2,1)*ST(3,3)*s(1)^2-PV(2,3)*ST(3,1)*s(1)^2+PV(2,1)*ST(3,3)*s(3)^2-PV(2,3)*ST(3,1)*s(3)^2)*EQQQ(5,3,3)...
        +(2*PV(2,3)*ST(3,1)*s(1)*s(3)-2*PV(2,1)*ST(3,3)*s(1)*s(3))*EQQQ(5,3,7)...
        +(PV(2,1)*ST(2,2)*s(1)^2-PV(2,2)*ST(2,1)*s(1)^2+PV(2,1)*ST(2,2)*s(3)^2-PV(2,2)*ST(2,1)*s(3)^2)*EQQQ(9,3,3)...
        +(2*PV(2,2)*ST(2,1)*s(1)*s(3)-2*PV(2,1)*ST(2,2)*s(1)*s(3))*EQQQ(9,3,7)...
        +(PV(1,3)*ST(3,2)*s(2)*s(3)-PV(1,2)*ST(3,3)*s(2)*s(3)-PV(3,1)*ST(2,3)*s(1)*s(3)+PV(3,3)*ST(2,1)*s(1)*s(3)-PV(3,1)*ST(3,2)*s(1)*s(2)+PV(3,2)*ST(3,1)*s(1)*s(2))*EQQQ(2,6,7)...
        +(PV(1,2)*ST(3,3)*s(3)^2-PV(1,3)*ST(3,2)*s(3)^2-PV(3,1)*ST(2,3)*s(1)*s(2)+PV(3,3)*ST(2,1)*s(1)*s(2)-PV(3,1)*ST(3,2)*s(1)*s(3)+PV(3,2)*ST(3,1)*s(1)*s(3))*EQQQ(4,3,6)...
        +(PV(3,1)*ST(2,3)*s(1)^2-PV(3,3)*ST(2,1)*s(1)^2+PV(1,2)*ST(3,3)*s(1)*s(2)-PV(1,3)*ST(3,2)*s(1)*s(2)+PV(3,1)*ST(3,2)*s(2)*s(3)-PV(3,2)*ST(3,1)*s(2)*s(3))*EQQQ(2,6,3)...
        +(PV(3,1)*ST(3,2)*s(1)^2-PV(3,2)*ST(3,1)*s(1)^2-PV(1,2)*ST(3,3)*s(1)*s(3)+PV(1,3)*ST(3,2)*s(1)*s(3)+PV(3,1)*ST(2,3)*s(2)*s(3)-PV(3,3)*ST(2,1)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(2,2) = (PV(2,2)*ST(3,3)*s(1)^2-PV(2,3)*ST(3,2)*s(1)^2+PV(2,2)*ST(3,3)*s(3)^2-PV(2,3)*ST(3,2)*s(3)^2)*EQQQ(1,3,3)...
        +(2*PV(2,3)*ST(3,2)*s(1)*s(3)-2*PV(2,2)*ST(3,3)*s(1)*s(3))*EQQQ(1,3,7)...
        +(PV(2,2)*ST(1,1)*s(1)^2-PV(2,1)*ST(1,2)*s(1)^2-PV(2,1)*ST(1,2)*s(3)^2+PV(2,2)*ST(1,1)*s(3)^2)*EQQQ(9,3,3)...
        +(2*PV(2,1)*ST(1,2)*s(1)*s(3)-2*PV(2,2)*ST(1,1)*s(1)*s(3))*EQQQ(9,3,7)...
        +(PV(1,3)*ST(3,1)*s(1)*s(3)-PV(1,1)*ST(3,3)*s(1)*s(3)+PV(3,1)*ST(1,3)*s(1)*s(3)-PV(3,3)*ST(1,1)*s(1)*s(3))*EQQQ(2,6,7)...
        +(PV(1,1)*ST(3,3)*s(1)*s(2)-PV(1,3)*ST(3,1)*s(1)*s(2)+PV(3,1)*ST(1,3)*s(1)*s(2)-PV(3,3)*ST(1,1)*s(1)*s(2))*EQQQ(4,3,6)...
        +(PV(3,3)*ST(1,1)*s(1)^2-PV(3,1)*ST(1,3)*s(1)^2+PV(1,1)*ST(3,3)*s(3)^2-PV(1,3)*ST(3,1)*s(3)^2)*EQQQ(2,6,3)...
        +(PV(1,3)*ST(3,1)*s(2)*s(3)-PV(1,1)*ST(3,3)*s(2)*s(3)-PV(3,1)*ST(1,3)*s(2)*s(3)+PV(3,3)*ST(1,1)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(2,3) = (PV(2,3)*ST(2,2)*s(1)^2-PV(2,2)*ST(2,3)*s(1)^2-PV(2,2)*ST(2,3)*s(3)^2+PV(2,3)*ST(2,2)*s(3)^2)*EQQQ(1,3,3)...
        +(2*PV(2,2)*ST(2,3)*s(1)*s(3)-2*PV(2,3)*ST(2,2)*s(1)*s(3))*EQQQ(1,3,7)...
        +(PV(2,3)*ST(1,1)*s(1)^2-PV(2,1)*ST(1,3)*s(1)^2-PV(2,1)*ST(1,3)*s(3)^2+PV(2,3)*ST(1,1)*s(3)^2)*EQQQ(5,3,3)...
        +(2*PV(2,1)*ST(1,3)*s(1)*s(3)-2*PV(2,3)*ST(1,1)*s(1)*s(3))*EQQQ(5,3,7)...
        +(PV(1,2)*ST(1,3)*s(2)*s(3)-PV(1,3)*ST(1,2)*s(2)*s(3)+PV(1,1)*ST(2,3)*s(1)*s(3)-PV(1,3)*ST(2,1)*s(1)*s(3)+PV(3,1)*ST(1,2)*s(1)*s(2)-PV(3,2)*ST(1,1)*s(1)*s(2))*EQQQ(2,6,7)...
        +(PV(1,3)*ST(1,2)*s(3)^2-PV(1,2)*ST(1,3)*s(3)^2-PV(1,1)*ST(2,3)*s(1)*s(2)+PV(1,3)*ST(2,1)*s(1)*s(2)+PV(3,1)*ST(1,2)*s(1)*s(3)-PV(3,2)*ST(1,1)*s(1)*s(3))*EQQQ(4,3,6)...
        +(PV(1,3)*ST(2,1)*s(3)^2-PV(1,1)*ST(2,3)*s(3)^2-PV(1,2)*ST(1,3)*s(1)*s(2)+PV(1,3)*ST(1,2)*s(1)*s(2)-PV(3,1)*ST(1,2)*s(2)*s(3)+PV(3,2)*ST(1,1)*s(2)*s(3))*EQQQ(2,6,3)...
        +(PV(3,2)*ST(1,1)*s(1)^2-PV(3,1)*ST(1,2)*s(1)^2+PV(1,2)*ST(1,3)*s(1)*s(3)-PV(1,3)*ST(1,2)*s(1)*s(3)+PV(1,1)*ST(2,3)*s(2)*s(3)-PV(1,3)*ST(2,1)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(3,1) = (PV(3,1)*ST(3,3)*s(1)^2-PV(3,3)*ST(3,1)*s(1)^2+PV(3,1)*ST(3,3)*s(2)^2-PV(3,3)*ST(3,1)*s(2)^2)*EQQQ(5,2,2)...
        +(2*PV(3,3)*ST(3,1)*s(1)*s(2)-2*PV(3,1)*ST(3,3)*s(1)*s(2))*EQQQ(5,2,4)...
        +(PV(3,1)*ST(2,2)*s(1)^2-PV(3,2)*ST(2,1)*s(1)^2+PV(3,1)*ST(2,2)*s(2)^2-PV(3,2)*ST(2,1)*s(2)^2)*EQQQ(9,2,2)...
        +(2*PV(3,2)*ST(2,1)*s(1)*s(2)-2*PV(3,1)*ST(2,2)*s(1)*s(2))*EQQQ(9,2,4)...
        +(PV(1,2)*ST(2,3)*s(2)*s(3)-PV(1,3)*ST(2,2)*s(2)*s(3)-PV(2,1)*ST(2,3)*s(1)*s(3)+PV(2,3)*ST(2,1)*s(1)*s(3)-PV(2,1)*ST(3,2)*s(1)*s(2)+PV(2,2)*ST(3,1)*s(1)*s(2))*EQQQ(2,6,7)...
        +(PV(1,3)*ST(2,2)*s(2)^2-PV(1,2)*ST(2,3)*s(2)^2-PV(2,1)*ST(2,3)*s(1)*s(2)+PV(2,3)*ST(2,1)*s(1)*s(2)-PV(2,1)*ST(3,2)*s(1)*s(3)+PV(2,2)*ST(3,1)*s(1)*s(3))*EQQQ(4,3,6)...
        +(PV(2,1)*ST(2,3)*s(1)^2-PV(2,3)*ST(2,1)*s(1)^2+PV(1,2)*ST(2,3)*s(1)*s(2)-PV(1,3)*ST(2,2)*s(1)*s(2)+PV(2,1)*ST(3,2)*s(2)*s(3)-PV(2,2)*ST(3,1)*s(2)*s(3))*EQQQ(2,6,3)...
        +(PV(2,1)*ST(3,2)*s(1)^2-PV(2,2)*ST(3,1)*s(1)^2-PV(1,2)*ST(2,3)*s(1)*s(3)+PV(1,3)*ST(2,2)*s(1)*s(3)+PV(2,1)*ST(2,3)*s(2)*s(3)-PV(2,3)*ST(2,1)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(3,2) = (PV(3,2)*ST(3,3)*s(1)^2-PV(3,3)*ST(3,2)*s(1)^2+PV(3,2)*ST(3,3)*s(2)^2-PV(3,3)*ST(3,2)*s(2)^2)*EQQQ(1,2,2)...
        +(2*PV(3,3)*ST(3,2)*s(1)*s(2)-2*PV(3,2)*ST(3,3)*s(1)*s(2))*EQQQ(1,2,4)...
        +(PV(3,2)*ST(1,1)*s(1)^2-PV(3,1)*ST(1,2)*s(1)^2-PV(3,1)*ST(1,2)*s(2)^2+PV(3,2)*ST(1,1)*s(2)^2)*EQQQ(9,2,2)...
        +(2*PV(3,1)*ST(1,2)*s(1)*s(2)-2*PV(3,2)*ST(1,1)*s(1)*s(2))*EQQQ(9,2,4)...
        +(PV(1,3)*ST(1,2)*s(2)*s(3)-PV(1,2)*ST(1,3)*s(2)*s(3)+PV(2,1)*ST(1,3)*s(1)*s(3)-PV(2,3)*ST(1,1)*s(1)*s(3)+PV(1,1)*ST(3,2)*s(1)*s(2)-PV(1,2)*ST(3,1)*s(1)*s(2))*EQQQ(2,6,7)...
        +(PV(1,2)*ST(1,3)*s(2)^2-PV(1,3)*ST(1,2)*s(2)^2+PV(2,1)*ST(1,3)*s(1)*s(2)-PV(2,3)*ST(1,1)*s(1)*s(2)-PV(1,1)*ST(3,2)*s(1)*s(3)+PV(1,2)*ST(3,1)*s(1)*s(3))*EQQQ(4,3,6)...
        +(PV(2,3)*ST(1,1)*s(1)^2-PV(2,1)*ST(1,3)*s(1)^2-PV(1,2)*ST(1,3)*s(1)*s(2)+PV(1,3)*ST(1,2)*s(1)*s(2)+PV(1,1)*ST(3,2)*s(2)*s(3)-PV(1,2)*ST(3,1)*s(2)*s(3))*EQQQ(2,6,3)...
        +(PV(1,2)*ST(3,1)*s(2)^2-PV(1,1)*ST(3,2)*s(2)^2+PV(1,2)*ST(1,3)*s(1)*s(3)-PV(1,3)*ST(1,2)*s(1)*s(3)-PV(2,1)*ST(1,3)*s(2)*s(3)+PV(2,3)*ST(1,1)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(3,3) = (PV(3,3)*ST(2,2)*s(1)^2-PV(3,2)*ST(2,3)*s(1)^2-PV(3,2)*ST(2,3)*s(2)^2+PV(3,3)*ST(2,2)*s(2)^2)*EQQQ(1,2,2)...
        +(2*PV(3,2)*ST(2,3)*s(1)*s(2)-2*PV(3,3)*ST(2,2)*s(1)*s(2))*EQQQ(1,2,4)...
        +(PV(3,3)*ST(1,1)*s(1)^2-PV(3,1)*ST(1,3)*s(1)^2-PV(3,1)*ST(1,3)*s(2)^2+PV(3,3)*ST(1,1)*s(2)^2)*EQQQ(5,2,2)...
        +(2*PV(3,1)*ST(1,3)*s(1)*s(2)-2*PV(3,3)*ST(1,1)*s(1)*s(2))*EQQQ(5,2,4)...
        +(PV(1,2)*ST(2,1)*s(1)*s(2)-PV(1,1)*ST(2,2)*s(1)*s(2)+PV(2,1)*ST(1,2)*s(1)*s(2)-PV(2,2)*ST(1,1)*s(1)*s(2))*EQQQ(2,6,7)...
        +(PV(1,1)*ST(2,2)*s(1)*s(3)-PV(1,2)*ST(2,1)*s(1)*s(3)+PV(2,1)*ST(1,2)*s(1)*s(3)-PV(2,2)*ST(1,1)*s(1)*s(3))*EQQQ(4,3,6)...
        +(PV(1,2)*ST(2,1)*s(2)*s(3)-PV(1,1)*ST(2,2)*s(2)*s(3)-PV(2,1)*ST(1,2)*s(2)*s(3)+PV(2,2)*ST(1,1)*s(2)*s(3))*EQQQ(2,6,3)...
        +(PV(2,2)*ST(1,1)*s(1)^2-PV(2,1)*ST(1,2)*s(1)^2+PV(1,1)*ST(2,2)*s(2)^2-PV(1,2)*ST(2,1)*s(2)^2)*EQQQ(3,8,2);
else
    EvRvRPbgVGQt(1,1) = (-PV(1,2)*ST(1,2)*s(2)^2-PV(1,2)*ST(1,2)*s(3)^2-PV(1,3)*ST(1,3)*s(2)^2-PV(1,3)*ST(1,3)*s(3)^2)*EQQQ(1,6,6)...
        + (2*PV(1,2)*ST(1,2)*s(2)*s(3)+2*PV(1,3)*ST(1,3)*s(2)*s(3))*EQQQ(1,6,8)...
        + (PV(1,1)*ST(2,2)*s(2)^2+PV(1,1)*ST(2,2)*s(3)^2)*EQQQ(5,6,6)...
        + (-2*PV(1,1)*ST(2,2)*s(2)*s(3))*EQQQ(5,6,8)...
        + (PV(1,1)*ST(3,3)*s(2)^2+PV(1,1)*ST(3,3)*s(3)^2)*EQQQ(9,6,6)...
        + (-2*PV(1,1)*ST(3,3)*s(2)*s(3))*EQQQ(9,6,8)...
        + (PV(2,1)*ST(1,2)*s(2)*s(3)-PV(2,2)*ST(2,2)*s(1)*s(3)+PV(3,1)*ST(1,3)*s(2)*s(3)-PV(2,3)*ST(2,3)*s(1)*s(3)-PV(3,2)*ST(3,2)*s(1)*s(2)-PV(3,3)*ST(3,3)*s(1)*s(2))*EQQQ(2,6,7)...
        + (PV(2,2)*ST(2,2)*s(1)*s(2)-PV(3,1)*ST(1,3)*s(2)^2-PV(2,1)*ST(1,2)*s(3)^2+PV(2,3)*ST(2,3)*s(1)*s(2)+PV(3,2)*ST(3,2)*s(1)*s(3)+PV(3,3)*ST(3,3)*s(1)*s(3))*EQQQ(4,3,6)...
        + (PV(2,2)*ST(2,2)*s(3)^2+PV(2,3)*ST(2,3)*s(3)^2-PV(2,1)*ST(1,2)*s(1)*s(2)+PV(3,1)*ST(1,3)*s(1)*s(2)-PV(3,2)*ST(3,2)*s(2)*s(3)-PV(3,3)*ST(3,3)*s(2)*s(3))*EQQQ(2,6,3)...
        + (PV(3,2)*ST(3,2)*s(2)^2+PV(3,3)*ST(3,3)*s(2)^2+PV(2,1)*ST(1,2)*s(1)*s(3)-PV(3,1)*ST(1,3)*s(1)*s(3)-PV(2,2)*ST(2,2)*s(2)*s(3)-PV(2,3)*ST(2,3)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(1,2) = (PV(1,2)*ST(1,1)*s(2)^2+PV(1,2)*ST(1,1)*s(3)^2)*EQQQ(1,6,6)...
        + (-2*PV(1,2)*ST(1,1)*s(2)*s(3))*EQQQ(1,6,8)...
        + (-PV(1,1)*ST(2,1)*s(2)^2-PV(1,1)*ST(2,1)*s(3)^2-PV(1,3)*ST(2,3)*s(2)^2-PV(1,3)*ST(2,3)*s(3)^2)*EQQQ(5,6,6)...
        + (2*PV(1,1)*ST(2,1)*s(2)*s(3)+2*PV(1,3)*ST(2,3)*s(2)*s(3))*EQQQ(5,6,8)...
        + (PV(1,2)*ST(3,3)*s(2)^2+PV(1,2)*ST(3,3)*s(3)^2)*EQQQ(9,6,6)...
        + (-2*PV(1,2)*ST(3,3)*s(2)*s(3))*EQQQ(9,6,8)...
        + (PV(2,2)*ST(2,1)*s(1)*s(3)-PV(2,3)*ST(1,3)*s(2)*s(3)-PV(2,1)*ST(1,1)*s(2)*s(3)+PV(3,2)*ST(1,3)*s(2)*s(3)+PV(3,2)*ST(3,1)*s(1)*s(2))*EQQQ(2,6,7)...
        + (PV(2,1)*ST(1,1)*s(3)^2+PV(2,3)*ST(1,3)*s(3)^2-PV(3,2)*ST(1,3)*s(2)^2-PV(2,2)*ST(2,1)*s(1)*s(2)-PV(3,2)*ST(3,1)*s(1)*s(3))*EQQQ(4,3,6)...
        + (PV(2,1)*ST(1,1)*s(1)*s(2)-PV(2,2)*ST(2,1)*s(3)^2+PV(2,3)*ST(1,3)*s(1)*s(2)+PV(3,2)*ST(1,3)*s(1)*s(2)+PV(3,2)*ST(3,1)*s(2)*s(3))*EQQQ(2,6,3)...
        + (PV(2,2)*ST(2,1)*s(2)*s(3)-PV(2,1)*ST(1,1)*s(1)*s(3)-PV(2,3)*ST(1,3)*s(1)*s(3)-PV(3,2)*ST(3,1)*s(2)^2-PV(3,2)*ST(1,3)*s(1)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(1,3) = (PV(1,3)*ST(1,1)*s(2)^2+PV(1,3)*ST(1,1)*s(3)^2)*EQQQ(1,6,6)...
        + (-2*PV(1,3)*ST(1,1)*s(2)*s(3))*EQQQ(1,6,8)...
        + (PV(1,3)*ST(2,2)*s(2)^2+PV(1,3)*ST(2,2)*s(3)^2)*EQQQ(5,6,6)...
        + (-2*PV(1,3)*ST(2,2)*s(2)*s(3))*EQQQ(5,6,8)...
        + (-PV(1,1)*ST(3,1)*s(2)^2-PV(1,1)*ST(3,1)*s(3)^2-PV(1,2)*ST(3,2)*s(2)^2-PV(1,2)*ST(3,2)*s(3)^2)*EQQQ(9,6,6)...
        + (2*PV(1,1)*ST(3,1)*s(2)*s(3)+2*PV(1,2)*ST(3,2)*s(2)*s(3))*EQQQ(9,6,8)...
        + (PV(2,3)*ST(1,2)*s(2)*s(3)-PV(3,1)*ST(1,1)*s(2)*s(3)+PV(2,3)*ST(2,1)*s(1)*s(3)-PV(3,2)*ST(1,2)*s(2)*s(3)+PV(3,3)*ST(3,1)*s(1)*s(2))*EQQQ(2,6,7)...
        + (PV(3,1)*ST(1,1)*s(2)^2-PV(2,3)*ST(1,2)*s(3)^2+PV(3,2)*ST(1,2)*s(2)^2-PV(2,3)*ST(2,1)*s(1)*s(2)-PV(3,3)*ST(3,1)*s(1)*s(3))*EQQQ(4,3,6)...
        + (PV(3,3)*ST(3,1)*s(2)*s(3)-PV(2,3)*ST(1,2)*s(1)*s(2)-PV(3,1)*ST(1,1)*s(1)*s(2)-PV(3,2)*ST(1,2)*s(1)*s(2)-PV(2,3)*ST(2,1)*s(3)^2)*EQQQ(2,6,3)...
        + (PV(2,3)*ST(1,2)*s(1)*s(3)-PV(3,3)*ST(3,1)*s(2)^2+PV(3,1)*ST(1,1)*s(1)*s(3)+PV(3,2)*ST(1,2)*s(1)*s(3)+PV(2,3)*ST(2,1)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(2,1) = (-PV(2,2)*ST(1,2)*s(1)^2-PV(2,2)*ST(1,2)*s(3)^2-PV(2,3)*ST(1,3)*s(1)^2-PV(2,3)*ST(1,3)*s(3)^2)*EQQQ(1,3,3)...
        + (2*PV(2,2)*ST(1,2)*s(1)*s(3)+2*PV(2,3)*ST(1,3)*s(1)*s(3))*EQQQ(1,3,7)...
        + (PV(2,1)*ST(2,2)*s(1)^2+PV(2,1)*ST(2,2)*s(3)^2)*EQQQ(5,3,3)...
        + (-2*PV(2,1)*ST(2,2)*s(1)*s(3))*EQQQ(5,3,7)...
        + (PV(2,1)*ST(3,3)*s(1)^2+PV(2,1)*ST(3,3)*s(3)^2)*EQQQ(9,3,3)...
        + (-2*PV(2,1)*ST(3,3)*s(1)*s(3))*EQQQ(9,3,7)...
        + (PV(1,1)*ST(1,2)*s(2)*s(3)-PV(1,2)*ST(2,2)*s(1)*s(3)-PV(1,3)*ST(2,3)*s(1)*s(3)+PV(3,1)*ST(2,3)*s(1)*s(3)+PV(3,1)*ST(3,2)*s(1)*s(2))*EQQQ(2,6,7)...
        + (PV(1,2)*ST(2,2)*s(1)*s(2)-PV(1,1)*ST(1,2)*s(3)^2+PV(1,3)*ST(2,3)*s(1)*s(2)+PV(3,1)*ST(2,3)*s(1)*s(2)+PV(3,1)*ST(3,2)*s(1)*s(3))*EQQQ(4,3,6)...
        + (PV(1,2)*ST(2,2)*s(3)^2+PV(1,3)*ST(2,3)*s(3)^2-PV(3,1)*ST(2,3)*s(1)^2-PV(1,1)*ST(1,2)*s(1)*s(2)-PV(3,1)*ST(3,2)*s(2)*s(3))*EQQQ(2,6,3)...
        + (PV(1,1)*ST(1,2)*s(1)*s(3)-PV(3,1)*ST(3,2)*s(1)^2-PV(1,2)*ST(2,2)*s(2)*s(3)-PV(1,3)*ST(2,3)*s(2)*s(3)-PV(3,1)*ST(2,3)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(2,2) = (PV(2,2)*ST(1,1)*s(1)^2+PV(2,2)*ST(1,1)*s(3)^2)*EQQQ(1,3,3)...
        + (-2*PV(2,2)*ST(1,1)*s(1)*s(3))*EQQQ(1,3,7)...
        + (-PV(2,1)*ST(2,1)*s(1)^2-PV(2,1)*ST(2,1)*s(3)^2-PV(2,3)*ST(2,3)*s(1)^2-PV(2,3)*ST(2,3)*s(3)^2)*EQQQ(5,3,3)...
        + (2*PV(2,1)*ST(2,1)*s(1)*s(3)+2*PV(2,3)*ST(2,3)*s(1)*s(3))*EQQQ(5,3,7)...
        + (PV(2,2)*ST(3,3)*s(1)^2+PV(2,2)*ST(3,3)*s(3)^2)*EQQQ(9,3,3)...
        + (-2*PV(2,2)*ST(3,3)*s(1)*s(3))*EQQQ(9,3,7)...
        + (PV(1,2)*ST(2,1)*s(1)*s(3)-PV(1,3)*ST(1,3)*s(2)*s(3)-PV(1,1)*ST(1,1)*s(2)*s(3)+PV(3,2)*ST(2,3)*s(1)*s(3)-PV(3,1)*ST(3,1)*s(1)*s(2)-PV(3,3)*ST(3,3)*s(1)*s(2))*EQQQ(2,6,7)...
        + (PV(1,1)*ST(1,1)*s(3)^2+PV(1,3)*ST(1,3)*s(3)^2-PV(1,2)*ST(2,1)*s(1)*s(2)+PV(3,2)*ST(2,3)*s(1)*s(2)-PV(3,1)*ST(3,1)*s(1)*s(3)-PV(3,3)*ST(3,3)*s(1)*s(3))*EQQQ(4,3,6)...
        + (PV(1,1)*ST(1,1)*s(1)*s(2)-PV(3,2)*ST(2,3)*s(1)^2-PV(1,2)*ST(2,1)*s(3)^2+PV(1,3)*ST(1,3)*s(1)*s(2)+PV(3,1)*ST(3,1)*s(2)*s(3)+PV(3,3)*ST(3,3)*s(2)*s(3))*EQQQ(2,6,3)...
        + (PV(3,1)*ST(3,1)*s(1)^2+PV(3,3)*ST(3,3)*s(1)^2-PV(1,1)*ST(1,1)*s(1)*s(3)-PV(1,3)*ST(1,3)*s(1)*s(3)+PV(1,2)*ST(2,1)*s(2)*s(3)-PV(3,2)*ST(2,3)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(2,3) = (PV(2,3)*ST(1,1)*s(1)^2+PV(2,3)*ST(1,1)*s(3)^2)*EQQQ(1,3,3)...
        + (-2*PV(2,3)*ST(1,1)*s(1)*s(3))*EQQQ(1,3,7)...
        + (PV(2,3)*ST(2,2)*s(1)^2+PV(2,3)*ST(2,2)*s(3)^2)*EQQQ(5,3,3)...
        + (-2*PV(2,3)*ST(2,2)*s(1)*s(3))*EQQQ(5,3,7)...
        + (-PV(2,1)*ST(3,1)*s(1)^2-PV(2,1)*ST(3,1)*s(3)^2-PV(2,2)*ST(3,2)*s(1)^2-PV(2,2)*ST(3,2)*s(3)^2)*EQQQ(9,3,3)...
        + (2*PV(2,1)*ST(3,1)*s(1)*s(3)+2*PV(2,2)*ST(3,2)*s(1)*s(3))*EQQQ(9,3,7)...
        + (PV(1,3)*ST(1,2)*s(2)*s(3)+PV(1,3)*ST(2,1)*s(1)*s(3)-PV(3,1)*ST(2,1)*s(1)*s(3)-PV(3,2)*ST(2,2)*s(1)*s(3)+PV(3,3)*ST(3,2)*s(1)*s(2))*EQQQ(2,6,7)...
        + (PV(3,3)*ST(3,2)*s(1)*s(3)-PV(1,3)*ST(2,1)*s(1)*s(2)-PV(3,1)*ST(2,1)*s(1)*s(2)-PV(3,2)*ST(2,2)*s(1)*s(2)-PV(1,3)*ST(1,2)*s(3)^2)*EQQQ(4,3,6)...
        + (PV(3,1)*ST(2,1)*s(1)^2-PV(1,3)*ST(2,1)*s(3)^2+PV(3,2)*ST(2,2)*s(1)^2-PV(1,3)*ST(1,2)*s(1)*s(2)-PV(3,3)*ST(3,2)*s(2)*s(3))*EQQQ(2,6,3)...
        + (PV(1,3)*ST(1,2)*s(1)*s(3)-PV(3,3)*ST(3,2)*s(1)^2+PV(1,3)*ST(2,1)*s(2)*s(3)+PV(3,1)*ST(2,1)*s(2)*s(3)+PV(3,2)*ST(2,2)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(3,1) = (-PV(3,2)*ST(1,2)*s(1)^2-PV(3,2)*ST(1,2)*s(2)^2-PV(3,3)*ST(1,3)*s(1)^2-PV(3,3)*ST(1,3)*s(2)^2)*EQQQ(1,2,2)...
        + (2*PV(3,2)*ST(1,2)*s(1)*s(2)+2*PV(3,3)*ST(1,3)*s(1)*s(2))*EQQQ(1,2,4)...
        + (PV(3,1)*ST(2,2)*s(1)^2+PV(3,1)*ST(2,2)*s(2)^2)*EQQQ(5,2,2)...
        + (-2*PV(3,1)*ST(2,2)*s(1)*s(2))*EQQQ(5,2,4)...
        + (PV(3,1)*ST(3,3)*s(1)^2+PV(3,1)*ST(3,3)*s(2)^2)*EQQQ(9,2,2)...
        + (-2*PV(3,1)*ST(3,3)*s(1)*s(2))*EQQQ(9,2,4)...
        + (PV(1,1)*ST(1,3)*s(2)*s(3)-PV(1,2)*ST(3,2)*s(1)*s(2)+PV(2,1)*ST(2,3)*s(1)*s(3)-PV(1,3)*ST(3,3)*s(1)*s(2)+PV(2,1)*ST(3,2)*s(1)*s(2))*EQQQ(2,6,7)...
        + (PV(2,1)*ST(2,3)*s(1)*s(2)-PV(1,1)*ST(1,3)*s(2)^2+PV(1,2)*ST(3,2)*s(1)*s(3)+PV(1,3)*ST(3,3)*s(1)*s(3)+PV(2,1)*ST(3,2)*s(1)*s(3))*EQQQ(4,3,6)...
        + (PV(1,1)*ST(1,3)*s(1)*s(2)-PV(2,1)*ST(2,3)*s(1)^2-PV(1,2)*ST(3,2)*s(2)*s(3)-PV(1,3)*ST(3,3)*s(2)*s(3)-PV(2,1)*ST(3,2)*s(2)*s(3))*EQQQ(2,6,3)...
        + (PV(1,2)*ST(3,2)*s(2)^2+PV(1,3)*ST(3,3)*s(2)^2-PV(2,1)*ST(3,2)*s(1)^2-PV(1,1)*ST(1,3)*s(1)*s(3)-PV(2,1)*ST(2,3)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(3,2) = (PV(3,2)*ST(1,1)*s(1)^2+PV(3,2)*ST(1,1)*s(2)^2)*EQQQ(1,2,2)...
        + (-2*PV(3,2)*ST(1,1)*s(1)*s(2))*EQQQ(1,2,4)...
        + (-PV(3,1)*ST(2,1)*s(1)^2-PV(3,1)*ST(2,1)*s(2)^2-PV(3,3)*ST(2,3)*s(1)^2-PV(3,3)*ST(2,3)*s(2)^2)*EQQQ(5,2,2)...
        + (2*PV(3,1)*ST(2,1)*s(1)*s(2)+2*PV(3,3)*ST(2,3)*s(1)*s(2))*EQQQ(5,2,4)...
        + (PV(3,2)*ST(3,3)*s(1)^2+PV(3,2)*ST(3,3)*s(2)^2)*EQQQ(9,2,2)...
        + (-2*PV(3,2)*ST(3,3)*s(1)*s(2))*EQQQ(9,2,4)...
        + (PV(1,2)*ST(1,3)*s(2)*s(3)+PV(1,2)*ST(3,1)*s(1)*s(2)+PV(2,2)*ST(2,3)*s(1)*s(3)-PV(2,1)*ST(3,1)*s(1)*s(2)-PV(2,3)*ST(3,3)*s(1)*s(2))*EQQQ(2,6,7)...
        + (PV(2,2)*ST(2,3)*s(1)*s(2)-PV(1,2)*ST(3,1)*s(1)*s(3)-PV(1,2)*ST(1,3)*s(2)^2-PV(2,1)*ST(3,1)*s(1)*s(3)-PV(2,3)*ST(3,3)*s(1)*s(3))*EQQQ(4,3,6)...
        + (PV(1,2)*ST(1,3)*s(1)*s(2)-PV(2,2)*ST(2,3)*s(1)^2+PV(1,2)*ST(3,1)*s(2)*s(3)+PV(2,1)*ST(3,1)*s(2)*s(3)+PV(2,3)*ST(3,3)*s(2)*s(3))*EQQQ(2,6,3)...
        + (PV(2,1)*ST(3,1)*s(1)^2-PV(1,2)*ST(3,1)*s(2)^2+PV(2,3)*ST(3,3)*s(1)^2-PV(1,2)*ST(1,3)*s(1)*s(3)-PV(2,2)*ST(2,3)*s(2)*s(3))*EQQQ(3,8,2);
    EvRvRPbgVGQt(3,3) = (PV(3,3)*ST(1,1)*s(1)^2+PV(3,3)*ST(1,1)*s(2)^2)*EQQQ(1,2,2)...
        + (-2*PV(3,3)*ST(1,1)*s(1)*s(2))*EQQQ(1,2,4)...
        + (PV(3,3)*ST(2,2)*s(1)^2+PV(3,3)*ST(2,2)*s(2)^2)*EQQQ(5,2,2)...
        + (-2*PV(3,3)*ST(2,2)*s(1)*s(2))*EQQQ(5,2,4)...
        + (-PV(3,1)*ST(3,1)*s(1)^2-PV(3,1)*ST(3,1)*s(2)^2-PV(3,2)*ST(3,2)*s(1)^2-PV(3,2)*ST(3,2)*s(2)^2)*EQQQ(9,2,2)...
        + (2*PV(3,1)*ST(3,1)*s(1)*s(2)+2*PV(3,2)*ST(3,2)*s(1)*s(2))*EQQQ(9,2,4)...
        + (PV(1,3)*ST(3,1)*s(1)*s(2)-PV(1,2)*ST(1,2)*s(2)*s(3)-PV(2,1)*ST(2,1)*s(1)*s(3)-PV(1,1)*ST(1,1)*s(2)*s(3)-PV(2,2)*ST(2,2)*s(1)*s(3)+PV(2,3)*ST(3,2)*s(1)*s(2))*EQQQ(2,6,7)...
        + (PV(1,1)*ST(1,1)*s(2)^2+PV(1,2)*ST(1,2)*s(2)^2-PV(2,1)*ST(2,1)*s(1)*s(2)-PV(2,2)*ST(2,2)*s(1)*s(2)-PV(1,3)*ST(3,1)*s(1)*s(3)+PV(2,3)*ST(3,2)*s(1)*s(3))*EQQQ(4,3,6)...
        + (PV(2,1)*ST(2,1)*s(1)^2+PV(2,2)*ST(2,2)*s(1)^2-PV(1,1)*ST(1,1)*s(1)*s(2)-PV(1,2)*ST(1,2)*s(1)*s(2)+PV(1,3)*ST(3,1)*s(2)*s(3)-PV(2,3)*ST(3,2)*s(2)*s(3))*EQQQ(2,6,3)...
        + (PV(1,1)*ST(1,1)*s(1)*s(3)-PV(2,3)*ST(3,2)*s(1)^2-PV(1,3)*ST(3,1)*s(2)^2+PV(1,2)*ST(1,2)*s(1)*s(3)+PV(2,1)*ST(2,1)*s(2)*s(3)+PV(2,2)*ST(2,2)*s(2)*s(3))*EQQQ(3,8,2);
end

SigmaMInv = diag([S(2,2)+S(3,3),S(1,1)+S(3,3),S(1,1)+S(2,2)]);
Sigmac = Sigma-P*SigmaMInv*P';
Sigmacxbg = Sigmac(:,1:3);

if defQS
    ExvRhatbdRptdt = (Sigmacxbg*V*EGQt' + Miu*EvRPbgVGQt + P*EvRvRPbgVGQt)*UT';
else
    ExvRhatbdRptdt = (Sigmacxbg*V*EGQt' + Miu*EvRPbgVGQt + P*EvRvRPbgVGQt)*VT';
end

% ExvRhatWdRptdt
if defQS
    EvRGdRpt = UT*vee(EQ*STT'-STT*EQ',[],false);
    EvRvRGdRpt = [STT(2,2)*EQ(2,2)+STT(3,3)*EQ(3,3), -STT(1,2)*EQ(2,2), -STT(1,3)*EQ(3,3)
        -STT(2,1)*EQ(1,1), STT(1,1)*EQ(1,1)+STT(3,3)*EQ(3,3), -STT(2,3)*EQ(3,3)
        -STT(3,1)*EQ(1,1), -STT(3,2)*EQ(2,2), STT(1,1)*EQ(1,1)+STT(2,2)*EQ(2,2)];
else
    SU = Stdt*UT;
    EvRGdRpt = vee(SU*EQ*VTT'-VTT*EQ'*SU');

    EvRvRGdRpt(1,1) = (SU(2,2)*VTT(3,3)-SU(3,2)*VTT(2,3))*EQ(2,2) + (SU(3,3)*VTT(2,2)-SU(2,3)*VTT(3,2))*EQ(3,3);
    EvRvRGdRpt(1,2) = (SU(3,2)*VTT(1,3)-SU(1,2)*VTT(3,3))*EQ(2,2) + (SU(1,3)*VTT(3,2)-SU(3,3)*VTT(1,2))*EQ(3,3);
    EvRvRGdRpt(1,3) = (SU(1,2)*VTT(2,3)-SU(2,2)*VTT(1,3))*EQ(2,2) + (SU(2,3)*VTT(1,2)-SU(1,3)*VTT(2,2))*EQ(3,3);
    EvRvRGdRpt(2,1) = (SU(3,1)*VTT(2,3)-SU(2,1)*VTT(3,3))*EQ(1,1) + (SU(2,3)*VTT(3,1)-SU(3,3)*VTT(2,1))*EQ(3,3);
    EvRvRGdRpt(2,2) = (SU(1,1)*VTT(3,3)-SU(3,1)*VTT(1,3))*EQ(1,1) + (SU(3,3)*VTT(1,1)-SU(1,3)*VTT(3,1))*EQ(3,3);
    EvRvRGdRpt(2,3) = (SU(2,1)*VTT(1,3)-SU(1,1)*VTT(2,3))*EQ(1,1) + (SU(1,3)*VTT(2,1)-SU(2,3)*VTT(1,1))*EQ(3,3);
    EvRvRGdRpt(3,1) = (SU(2,1)*VTT(3,2)-SU(3,1)*VTT(2,2))*EQ(1,1) + (SU(3,2)*VTT(2,1)-SU(2,2)*VTT(3,1))*EQ(2,2);
    EvRvRGdRpt(3,2) = (SU(3,1)*VTT(1,2)-SU(1,1)*VTT(3,2))*EQ(1,1) + (SU(1,2)*VTT(3,1)-SU(3,2)*VTT(1,1))*EQ(2,2);
    EvRvRGdRpt(3,3) = (SU(1,1)*VTT(2,2)-SU(2,1)*VTT(1,2))*EQ(1,1) + (SU(2,2)*VTT(1,1)-SU(1,2)*VTT(2,1))*EQ(2,2);
end

ExvRGdRpt = Miu*EvRGdRpt' + P*EvRvRGdRpt;
ExvRdRpt = Miu*EvRdRpt' + P*EvRvRdRpt;

ExvRhatWdRptdt = dt*ExvRGdRpt - dt*trace(Ggu)*ExvRdRpt;

% final result
ExvRptdt = ExvRdRptdt + dt*ExvRhatbdRptdt + 0.5*ExvRhatWdRptdt;

%% E[v'R(t+dt)v'R(t+dt)]
EvRpvRptdt = getEvRvRtdt(omega,Miubg,Pbg,U,s,V,Hgu,EQQ,EQQQ,Utdt,Stdt,Vtdt,dt,true,defQS);

%% E[x(t+dt)x(t+dt)]
EvRvRt(1,1) = (s(2)^2+s(3)^2)*EQQ(6,6)-2*s(2)*s(3)*EQQ(6,8);
EvRvRt(2,2) = (s(1)^2+s(3)^2)*EQQ(3,3)-2*s(1)*s(3)*EQQ(3,7);
EvRvRt(3,3) = (s(1)^2+s(2)^2)*EQQ(2,2)-2*s(1)*s(2)*EQQ(2,4);
Exxt = Sigmac+Miu*Miu'+P*EvRvRt*P';

Ebgbgtdt = Exxt(1:3,1:3) + dt*Ggv;
Ebgptdt = Exxt(1:3,4:6) + dt*Exxt(1:3,7:9);
Ebgbatdt = Exxt(1:3,10:12);
Epptdt = Exxt(4:6,4:6) + dt*(Exxt(4:6,7:9)+Exxt(7:9,4:6)) + dt^2*Exxt(7:9,7:9);
Epbatdt = Exxt(4:6,10:12) + dt*Exxt(7:9,10:12);
Ebabatdt = Exxt(10:12,10:12) + dt*Gav;

if defQS
    ERavRt = [0, Va(3)*EQ(3,3), -Va(2)*EQ(2,2);
        -Va(3)*EQ(3,3), 0, Va(1)*EQ(1,1);
        Va(2)*EQ(2,2), -Va(1)*EQ(1,1), 0];
else
    ERavRt = [0, Va(3)*EQ(1,1), -Va(2)*EQ(1,1);
        -Va(3)*EQ(2,2), 0, Va(1)*EQ(2,2);
        Va(2)*EQ(3,3), -Va(1)*EQ(3,3), 0];
end
ERavRt = U*ERavRt;

if defQS
    ERPbavRt(1) = -VPba(2,3)*EQ(2,2) + VPba(3,2)*EQ(3,3);
    ERPbavRt(2) = VPba(1,3)*EQ(1,1) - VPba(3,1)*EQ(3,3);
    ERPbavRt(3) = -VPba(1,2)*EQ(1,1) + VPba(2,1)*EQ(2,2);
else
    ERPbavRt(1) = (-VPba(2,3)+VPba(3,2))*EQ(1,1);
    ERPbavRt(2) = (VPba(1,3)-VPba(3,1))*EQ(2,2);
    ERPbavRt(3) = (-VPba(1,2)+VPba(2,1))*EQ(3,3);
end
ERPbavRt = U*ERPbavRt;

if defQS
    ERPbavRvRt(1,1) = (VPba(1,1)*s(2)^2+VPba(1,1)*s(3)^2)*EQQQ(1,6,6)...
        + (-2*VPba(1,1)*s(2)*s(3))*EQQQ(1,6,8) +(VPba(2,2)*s(1)*s(3)+VPba(3,3)*s(1)*s(2))*EQQQ(2,6,7)...
        + (-VPba(2,2)*s(1)*s(2)-VPba(3,3)*s(1)*s(3))*EQQQ(4,3,6)...
        + (VPba(3,3)*s(2)*s(3)-VPba(2,2)*s(3)^2)*EQQQ(2,6,3)...
        + (VPba(2,2)*s(2)*s(3)-VPba(3,3)*s(2)^2)*EQQQ(3,8,2);
    ERPbavRvRt(1,2) = (VPba(1,2)*s(1)^2+VPba(1,2)*s(3)^2)*EQQQ(1,3,3)...
        + (-2*VPba(1,2)*s(1)*s(3))*EQQQ(1,3,7) +(VPba(2,1)*s(1)*s(3))*EQQQ(2,6,7)...
        + (-VPba(2,1)*s(1)*s(2))*EQQQ(4,3,6) +(-VPba(2,1)*s(3)^2)*EQQQ(2,6,3) +(VPba(2,1)*s(2)*s(3))*EQQQ(3,8,2);
    ERPbavRvRt(1,3) = (VPba(1,3)*s(1)^2+VPba(1,3)*s(2)^2)*EQQQ(1,2,2)...
        + (-2*VPba(1,3)*s(1)*s(2))*EQQQ(1,2,4) +(VPba(3,1)*s(1)*s(2))*EQQQ(2,6,7)...
        + (-VPba(3,1)*s(1)*s(3))*EQQQ(4,3,6) +(VPba(3,1)*s(2)*s(3))*EQQQ(2,6,3) +(-VPba(3,1)*s(2)^2)*EQQQ(3,8,2);
    ERPbavRvRt(2,1) = (VPba(2,1)*s(2)^2+VPba(2,1)*s(3)^2)*EQQQ(5,6,6)...
        + (-2*VPba(2,1)*s(2)*s(3))*EQQQ(5,6,8) +(VPba(1,2)*s(2)*s(3))*EQQQ(2,6,7)...
        + (-VPba(1,2)*s(3)^2)*EQQQ(4,3,6) +(-VPba(1,2)*s(1)*s(2))*EQQQ(2,6,3) +(VPba(1,2)*s(1)*s(3))*EQQQ(3,8,2);
    ERPbavRvRt(2,2) = (VPba(2,2)*s(1)^2+VPba(2,2)*s(3)^2)*EQQQ(5,3,3)...
        + (-2*VPba(2,2)*s(1)*s(3))*EQQQ(5,3,7) +(VPba(1,1)*s(2)*s(3)+VPba(3,3)*s(1)*s(2))*EQQQ(2,6,7)...
        + (VPba(3,3)*s(1)*s(3)-VPba(1,1)*s(3)^2)*EQQQ(4,3,6)...
        + (-VPba(1,1)*s(1)*s(2)-VPba(3,3)*s(2)*s(3))*EQQQ(2,6,3)...
        + (VPba(1,1)*s(1)*s(3)-VPba(3,3)*s(1)^2)*EQQQ(3,8,2);
    ERPbavRvRt(2,3) = (VPba(2,3)*s(1)^2+VPba(2,3)*s(2)^2)*EQQQ(5,2,2)...
        + (-2*VPba(2,3)*s(1)*s(2))*EQQQ(5,2,4) +(VPba(3,2)*s(1)*s(2))*EQQQ(2,6,7)...
        + (VPba(3,2)*s(1)*s(3))*EQQQ(4,3,6) +(-VPba(3,2)*s(2)*s(3))*EQQQ(2,6,3) +(-VPba(3,2)*s(1)^2)*EQQQ(3,8,2);
    ERPbavRvRt(3,1) = (VPba(3,1)*s(2)^2+VPba(3,1)*s(3)^2)*EQQQ(9,6,6)...
        + (-2*VPba(3,1)*s(2)*s(3))*EQQQ(9,6,8) +(VPba(1,3)*s(2)*s(3))*EQQQ(2,6,7)...
        + (-VPba(1,3)*s(2)^2)*EQQQ(4,3,6) +(VPba(1,3)*s(1)*s(2))*EQQQ(2,6,3) +(-VPba(1,3)*s(1)*s(3))*EQQQ(3,8,2);
    ERPbavRvRt(3,2) = (VPba(3,2)*s(1)^2+VPba(3,2)*s(3)^2)*EQQQ(9,3,3)...
        + (-2*VPba(3,2)*s(1)*s(3))*EQQQ(9,3,7) +(VPba(2,3)*s(1)*s(3))*EQQQ(2,6,7)...
        + (VPba(2,3)*s(1)*s(2))*EQQQ(4,3,6) +(-VPba(2,3)*s(1)^2)*EQQQ(2,6,3) +(-VPba(2,3)*s(2)*s(3))*EQQQ(3,8,2);
    ERPbavRvRt(3,3) = (VPba(3,3)*s(1)^2+VPba(3,3)*s(2)^2)*EQQQ(9,2,2)...
        + (-2*VPba(3,3)*s(1)*s(2))*EQQQ(9,2,4) +(VPba(1,1)*s(2)*s(3)+VPba(2,2)*s(1)*s(3))*EQQQ(2,6,7)...
        + (VPba(2,2)*s(1)*s(2)-VPba(1,1)*s(2)^2)*EQQQ(4,3,6)...
        + (VPba(1,1)*s(1)*s(2)-VPba(2,2)*s(1)^2)*EQQQ(2,6,3)...
        + (-VPba(1,1)*s(1)*s(3)-VPba(2,2)*s(2)*s(3))*EQQQ(3,8,2);
else
    ERPbavRvRt(1,1) = (VPba(1,1)*s(2)^2+VPba(1,1)*s(3)^2)*EQQQ(1,6,6)...
        + (-2*VPba(1,1)*s(2)*s(3))*EQQQ(1,6,8) +(VPba(2,2)*s(2)*s(3)+VPba(3,3)*s(2)*s(3))*EQQQ(2,6,7)...
        + (-VPba(2,2)*s(3)^2-VPba(3,3)*s(2)^2)*EQQQ(4,3,6)...
        + (VPba(3,3)*s(1)*s(2)-VPba(2,2)*s(1)*s(2))*EQQQ(2,6,3)...
        + (VPba(2,2)*s(1)*s(3)-VPba(3,3)*s(1)*s(3))*EQQQ(3,8,2);
    ERPbavRvRt(1,2) = (VPba(1,2)*s(1)^2+VPba(1,2)*s(3)^2)*EQQQ(1,3,3)...
        + (-2*VPba(1,2)*s(1)*s(3))*EQQQ(1,3,7) +(VPba(2,1)*s(2)*s(3))*EQQQ(2,6,7)...
        + (-VPba(2,1)*s(3)^2)*EQQQ(4,3,6) +(-VPba(2,1)*s(1)*s(2))*EQQQ(2,6,3) +(VPba(2,1)*s(1)*s(3))*EQQQ(3,8,2);
    ERPbavRvRt(1,3) = (VPba(1,3)*s(1)^2+VPba(1,3)*s(2)^2)*EQQQ(1,2,2)...
        + (-2*VPba(1,3)*s(1)*s(2))*EQQQ(1,2,4) +(VPba(3,1)*s(2)*s(3))*EQQQ(2,6,7)...
        + (-VPba(3,1)*s(2)^2)*EQQQ(4,3,6) +(VPba(3,1)*s(1)*s(2))*EQQQ(2,6,3) +(-VPba(3,1)*s(1)*s(3))*EQQQ(3,8,2);
    ERPbavRvRt(2,1) = (VPba(2,1)*s(2)^2+VPba(2,1)*s(3)^2)*EQQQ(5,6,6)...
        + (-2*VPba(2,1)*s(2)*s(3))*EQQQ(5,6,8) +(VPba(1,2)*s(1)*s(3))*EQQQ(2,6,7)...
        + (-VPba(1,2)*s(1)*s(2))*EQQQ(4,3,6) +(-VPba(1,2)*s(3)^2)*EQQQ(2,6,3) +(VPba(1,2)*s(2)*s(3))*EQQQ(3,8,2);
    ERPbavRvRt(2,2) = (VPba(2,2)*s(1)^2+VPba(2,2)*s(3)^2)*EQQQ(5,3,3)...
        + (-2*VPba(2,2)*s(1)*s(3))*EQQQ(5,3,7) +(VPba(1,1)*s(1)*s(3)+VPba(3,3)*s(1)*s(3))*EQQQ(2,6,7)...
        + (VPba(3,3)*s(1)*s(2)-VPba(1,1)*s(1)*s(2))*EQQQ(4,3,6)...
        + (-VPba(1,1)*s(3)^2-VPba(3,3)*s(1)^2)*EQQQ(2,6,3)...
        + (VPba(1,1)*s(2)*s(3)-VPba(3,3)*s(2)*s(3))*EQQQ(3,8,2);
    ERPbavRvRt(2,3) = (VPba(2,3)*s(1)^2+VPba(2,3)*s(2)^2)*EQQQ(5,2,2)...
        + (-2*VPba(2,3)*s(1)*s(2))*EQQQ(5,2,4) +(VPba(3,2)*s(1)*s(3))*EQQQ(2,6,7)...
        + (VPba(3,2)*s(1)*s(2))*EQQQ(4,3,6) +(-VPba(3,2)*s(1)^2)*EQQQ(2,6,3) +(-VPba(3,2)*s(2)*s(3))*EQQQ(3,8,2);
    ERPbavRvRt(3,1) = (VPba(3,1)*s(2)^2+VPba(3,1)*s(3)^2)*EQQQ(9,6,6)...
        + (-2*VPba(3,1)*s(2)*s(3))*EQQQ(9,6,8) +(VPba(1,3)*s(1)*s(2))*EQQQ(2,6,7)...
        + (-VPba(1,3)*s(1)*s(3))*EQQQ(4,3,6) +(VPba(1,3)*s(2)*s(3))*EQQQ(2,6,3) +(-VPba(1,3)*s(2)^2)*EQQQ(3,8,2);
    ERPbavRvRt(3,2) = (VPba(3,2)*s(1)^2+VPba(3,2)*s(3)^2)*EQQQ(9,3,3)...
        + (-2*VPba(3,2)*s(1)*s(3))*EQQQ(9,3,7) +(VPba(2,3)*s(1)*s(2))*EQQQ(2,6,7)...
        + (VPba(2,3)*s(1)*s(3))*EQQQ(4,3,6) +(-VPba(2,3)*s(2)*s(3))*EQQQ(2,6,3) +(-VPba(2,3)*s(1)^2)*EQQQ(3,8,2);
    ERPbavRvRt(3,3) = (VPba(3,3)*s(1)^2+VPba(3,3)*s(2)^2)*EQQQ(9,2,2)...
        + (-2*VPba(3,3)*s(1)*s(2))*EQQQ(9,2,4) +(VPba(1,1)*s(1)*s(2)+VPba(2,2)*s(1)*s(2))*EQQQ(2,6,7)...
        + (VPba(2,2)*s(1)*s(3)-VPba(1,1)*s(1)*s(3))*EQQQ(4,3,6)...
        + (VPba(1,1)*s(2)*s(3)-VPba(2,2)*s(2)*s(3))*EQQQ(2,6,3)...
        + (-VPba(1,1)*s(2)^2-VPba(2,2)*s(1)^2)*EQQQ(3,8,2);
end
ERPbavRvRt = U*ERPbavRvRt;

Evbgtdt = Exxt(7:9,1:3) + dt*ERt*((a+Miuba)*Miubg' + Sigmac(10:12,1:3))...
    + dt*ERavRt*Pbg' + dt*ERPbavRt*Miubg' + dt*ERPbavRvRt*Pbg' - dt*g*Miubg';

Evptdt = Exxt(7:9,4:6) + dt*Exxt(7:9,7:9)...
    + dt*ERt*((a+Miuba)*Miup' + Sigmac(10:12,4:6))...
    + dt*ERavRt*Pp' + dt*ERPbavRt*Miup' + dt*ERPbavRvRt*Pp'...
    + dt^2*ERt*((a+Miuba)*Miuv' + Sigmac(10:12,7:9))...
    + dt^2*ERavRt*Pv' + dt^2*ERPbavRt*Miuv' + dt^2*ERPbavRvRt*Pv'...
    - dt*g*(Miup+dt*Miuv)';

Evbatdt = Exxt(7:9,10:12) + dt*ERt*((a+Miuba)*Miuba' + Sigmac(10:12,10:12))...
    + dt*ERavRt*Pba' + dt*ERPbavRt*Miuba' + dt*ERPbavRvRt*Pba' - dt*g*Miuba';

ERRt(1,1) = (V(1,1)^2+V(2,1)^2+V(3,1)^2)*EQQ(1,1) +(V(1,2)^2+V(2,2)^2+V(3,2)^2)*EQQ(2,2) +(V(1,3)^2+V(2,3)^2+V(3,3)^2)*EQQ(3,3);
ERRt(1,2) = (V(1,1)*V(1,2)+V(2,1)*V(2,2)+V(3,1)*V(3,2))*EQQ(1,5) +(V(1,1)*V(1,2)+V(2,1)*V(2,2)+V(3,1)*V(3,2))*EQQ(2,4);
ERRt(1,3) = (V(1,1)*V(1,3)+V(2,1)*V(2,3)+V(3,1)*V(3,3))*EQQ(1,9) +(V(1,1)*V(1,3)+V(2,1)*V(2,3)+V(3,1)*V(3,3))*EQQ(3,7);
ERRt(2,1) = (V(1,1)*V(1,2)+V(2,1)*V(2,2)+V(3,1)*V(3,2))*EQQ(1,5) +(V(1,1)*V(1,2)+V(2,1)*V(2,2)+V(3,1)*V(3,2))*EQQ(2,4);
ERRt(2,2) = (V(1,2)^2+V(2,2)^2+V(3,2)^2)*EQQ(5,5) +(V(1,1)^2+V(2,1)^2+V(3,1)^2)*EQQ(2,2) +(V(1,3)^2+V(2,3)^2+V(3,3)^2)*EQQ(6,6);
ERRt(2,3) = (V(1,2)*V(1,3)+V(2,2)*V(2,3)+V(3,2)*V(3,3))*EQQ(5,9) +(V(1,2)*V(1,3)+V(2,2)*V(2,3)+V(3,2)*V(3,3))*EQQ(6,8);
ERRt(3,1) = (V(1,1)*V(1,3)+V(2,1)*V(2,3)+V(3,1)*V(3,3))*EQQ(1,9) +(V(1,1)*V(1,3)+V(2,1)*V(2,3)+V(3,1)*V(3,3))*EQQ(3,7);
ERRt(3,2) = (V(1,2)*V(1,3)+V(2,2)*V(2,3)+V(3,2)*V(3,3))*EQQ(5,9) +(V(1,2)*V(1,3)+V(2,2)*V(2,3)+V(3,2)*V(3,3))*EQQ(6,8);
ERRt(3,3) = (V(1,3)^2+V(2,3)^2+V(3,3)^2)*EQQ(9,9) +(V(1,1)^2+V(2,1)^2+V(3,1)^2)*EQQ(3,3) +(V(1,2)^2+V(2,2)^2+V(3,2)^2)*EQQ(6,6);
ERRt = U*ERRt*U';

VaaV = V'*(a+Miuba)*(a+Miuba)'*V;
ERaaRt(1,1) = VaaV(1,1)*EQQ(1,1) +VaaV(2,2)*EQQ(2,2) +VaaV(3,3)*EQQ(3,3);
ERaaRt(1,2) = VaaV(1,2)*EQQ(1,5) +VaaV(2,1)*EQQ(2,4);
ERaaRt(1,3) = VaaV(1,3)*EQQ(1,9) +VaaV(3,1)*EQQ(3,7);
ERaaRt(2,1) = VaaV(2,1)*EQQ(1,5) +VaaV(1,2)*EQQ(2,4);
ERaaRt(2,2) = VaaV(2,2)*EQQ(5,5) +VaaV(1,1)*EQQ(2,2) +VaaV(3,3)*EQQ(6,6);
ERaaRt(2,3) = VaaV(2,3)*EQQ(5,9) +VaaV(3,2)*EQQ(6,8);
ERaaRt(3,1) = VaaV(3,1)*EQQ(1,9) +VaaV(1,3)*EQQ(3,7);
ERaaRt(3,2) = VaaV(3,2)*EQQ(5,9) +VaaV(2,3)*EQQ(6,8);
ERaaRt(3,3) = VaaV(3,3)*EQQ(9,9) +VaaV(1,1)*EQQ(3,3) +VaaV(2,2)*EQQ(6,6);
ERaaRt = U*ERaaRt*U';

Evvtdt = Exxt(7:9,7:9) + dt*ERt*((a+Miuba)*Miuv' + Sigmac(10:12,7:9))...
    + dt*ERavRt*Pv' + dt*ERPbavRt*Miuv' + dt*ERPbavRvRt*Pv'...
    + (dt*ERt*((a+Miuba)*Miuv' + Sigmac(10:12,7:9))...
    + dt*ERavRt*Pv' + dt*ERPbavRt*Miuv' + dt*ERPbavRvRt*Pv')'...
    + dt^2*ERaaRt + dt*Gau*ERRt...
    - dt*g*(Miuv + dt*ERt*(a+Miuba) + dt*ERPbavRt)'...
    - dt*(Miuv + dt*ERt*(a+Miuba) + dt*ERPbavRt)*g' + dt^2*g*g'; %#ok<*MHERM>

% final result
Exxtdt = [Ebgbgtdt, Ebgptdt, Evbgtdt', Ebgbatdt;
    Ebgptdt', Epptdt, Evptdt', Epbatdt;
    Evbgtdt, Evptdt, Evvtdt, Evbatdt;
    Ebgbatdt', Epbatdt', Evbatdt', Ebabatdt];

%% MLE
covxxtdt = Exxtdt-Extdt*Extdt';
covxvRptdt = ExvRptdt;
covvRpvRptdt = EvRpvRptdt;

Ptdt = covxvRptdt*covvRpvRptdt^-1;
Miutdt = Extdt;
Sigmatdt = covxxtdt - Ptdt*covxvRptdt' + Ptdt*(trace(Stdt)*eye(3)-Stdt)*Ptdt';

end

